{% extends 'management/base_management.html' %}
{% load humanize %}

{% block title %}Corp Wallet Monitor{% endblock %}

{% block management_content %}
<!-- REMOVED: h-full to prevent layout constraint issues on mobile -->
<div class="flex flex-col gap-6 animate-fade-in pb-6">

    <!-- HEADER / FILTERS -->
    <div class="glass-panel p-4 flex flex-col md:flex-row justify-between items-center gap-4 bg-slate-900/90 shrink-0">
        <div class="flex items-center gap-6">
            <div>
                <h1 class="text-lg font-bold text-white tracking-tight">Corporation Wallet Monitor</h1>
                <p class="text-xs text-slate-400">Last Sync: {{ config.last_sync|timesince }} ago</p>
            </div>

            <!-- NEXT SYNC TIMER -->
            {% if next_sync %}
            <div class="hidden md:flex items-center gap-2 px-3 py-1.5 rounded-lg bg-black/20 border border-white/5" id="sync-timer-container">
                <span class="text-[10px] text-slate-500 uppercase font-bold tracking-wider">Next Sync</span>
                <span class="text-xs font-mono text-brand-400 font-bold" id="next-sync-timer">--:--</span>
            </div>
            <script>
                // Pass Django timestamp to JS
                window.NEXT_SYNC_ISO = "{{ next_sync.isoformat }}";
            </script>
            {% endif %}
        </div>

        <div class="flex gap-4 items-center flex-wrap">
            <div class="flex items-center gap-2 bg-black/30 p-1.5 rounded border border-white/10">
                <input type="date" id="start-date" class="bg-transparent text-xs text-white outline-none">
                <span class="text-slate-500">-</span>
                <input type="date" id="end-date" class="bg-transparent text-xs text-white outline-none">
            </div>

            <div class="flex gap-2 text-xs">
                {% for i in "1234567" %}
                <label class="flex items-center gap-1 cursor-pointer select-none">
                    <input type="checkbox" name="div" value="{{ i }}" checked onchange="loadData(1)"
                           class="rounded bg-slate-800 border-slate-600 text-brand-500 focus:ring-0 w-3 h-3">
                    <span class="text-slate-300">Div {{ i }}</span>
                </label>
                {% endfor %}
            </div>

            <button onclick="loadData(1)" class="btn-primary py-1.5 px-4 text-xs shadow-brand-500/20">Apply</button>
        </div>
    </div>

    <!-- SUMMARY CARDS -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 shrink-0">
        <div class="glass-panel p-4 text-center">
            <div class="label-text mb-1">Total Income</div>
            <div class="text-2xl font-mono font-bold text-green-400" id="val-income">...</div>
        </div>
        <div class="glass-panel p-4 text-center">
            <div class="label-text mb-1">Total Outcome</div>
            <div class="text-2xl font-mono font-bold text-red-400" id="val-outcome">...</div>
        </div>
        <div class="glass-panel p-4 text-center">
            <div class="label-text mb-1">Net Change</div>
            <div class="text-2xl font-mono font-bold text-white" id="val-net">...</div>
        </div>
    </div>

    <!-- CHARTS ROW 1 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 shrink-0">
        <div class="glass-panel p-4 flex flex-col h-80">
            <h3 class="label-text mb-2">Monthly Cashflow</h3>
            <div class="flex-grow relative min-h-0"><canvas id="chart-monthly"></canvas></div>
        </div>
        <div class="glass-panel p-4 flex flex-col h-80">
            <h3 class="label-text mb-2">Category Breakdown (Income)</h3>
            <div class="flex-grow relative min-h-0"><canvas id="chart-cat"></canvas></div>
        </div>
    </div>

    <!-- CHARTS ROW 2 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 shrink-0">
        <div class="glass-panel p-4 flex flex-col h-80">
            <h3 class="label-text mb-2">Top Payers (Count)</h3>
            <div class="flex-grow relative min-h-0"><canvas id="chart-payers-count"></canvas></div>
        </div>
        <div class="glass-panel p-4 flex flex-col h-80">
            <h3 class="label-text mb-2">Top Payers (ISK)</h3>
            <div class="flex-grow relative min-h-0"><canvas id="chart-payers-isk"></canvas></div>
        </div>
    </div>

    <!-- TRANSACTIONS -->
    <div class="glass-panel flex flex-col overflow-hidden min-h-[500px]">
        <div class="p-4 border-b border-white/5 bg-slate-900/50 shrink-0 flex justify-between items-center">
            <h3 class="label-text mb-0">Recent Transactions</h3>

            <!-- Rows Selector -->
            <div class="flex items-center gap-2">
                <span class="text-[10px] text-slate-500 uppercase font-bold">Rows:</span>
                <select id="limit-select" onchange="loadData(1)" class="bg-black/30 border border-slate-700 text-slate-300 text-xs rounded px-2 py-1 outline-none focus:border-brand-500">
                    <option value="10">10</option>
                    <option value="25" selected>25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
        </div>

        <div class="overflow-auto custom-scrollbar flex-grow relative bg-slate-900/20">
            <table class="w-full text-left text-xs text-slate-400 border-collapse">
                <thead class="bg-slate-900/95 text-[10px] uppercase font-bold sticky top-0 z-10 backdrop-blur-md shadow-sm">
                    <!-- MAIN HEADER ROW -->
                    <tr>
                        <th class="p-3 border-b border-white/5 w-32">Date</th>
                        <th class="p-3 border-b border-white/5 text-center w-16">Div</th>
                        <th class="p-3 border-b border-white/5 text-right w-32">Amount</th>
                        <th class="p-3 border-b border-white/5 w-48">From / To</th>
                        <th class="p-3 border-b border-white/5 w-32">Type</th>
                        <th class="p-3 border-b border-white/5 w-48">Category</th>
                        <th class="p-3 border-b border-white/5">Reason</th>
                    </tr>
                    <!-- FILTER ROW -->
                    <tr class="bg-slate-900/90 border-b border-white/10">
                        <td class="p-2"></td> <!-- Date placeholder -->
                        <td class="p-2"></td> <!-- Div placeholder -->
                        <td class="p-2">
                            <input type="text" id="filter-amount" class="w-full bg-black/40 border border-white/10 rounded px-2 py-1 text-[10px] text-right text-slate-300 placeholder-slate-600 focus:border-brand-500 outline-none" placeholder="Min Amount..." onkeyup="debouncedLoad()">
                        </td>
                        <td class="p-2">
                            <input type="text" id="filter-party" class="w-full bg-black/40 border border-white/10 rounded px-2 py-1 text-[10px] text-slate-300 placeholder-slate-600 focus:border-brand-500 outline-none" placeholder="Filter Name..." onkeyup="debouncedLoad()">
                        </td>
                        <td class="p-2">
                            <input type="text" id="filter-type" class="w-full bg-black/40 border border-white/10 rounded px-2 py-1 text-[10px] text-slate-300 placeholder-slate-600 focus:border-brand-500 outline-none" placeholder="Filter Type..." onkeyup="debouncedLoad()">
                        </td>
                        <td class="p-2">
                            <select id="filter-category" class="w-full bg-black/40 border border-white/10 rounded px-2 py-1 text-[10px] text-slate-300 focus:border-brand-500 outline-none" onchange="loadData(1)">
                                <option value="">All Categories</option>
                                <option value="srp_in">SRP In</option>
                                <option value="srp_out">SRP Out</option>
                                <option value="internal_transfer">Internal Transfer</option>
                                <option value="giveaway">Giveaway</option>
                                <option value="manual_change">Manual Change</option>
                                <option value="manual_out">Manual Out</option>
                                <option value="tax">Tax</option>
                                <option value="other">Other</option>
                            </select>
                        </td>
                        <td class="p-2">
                            <input type="text" id="filter-reason" class="w-full bg-black/40 border border-white/10 rounded px-2 py-1 text-[10px] text-slate-300 placeholder-slate-600 focus:border-brand-500 outline-none" placeholder="Reason... use [empty]" onkeyup="debouncedLoad()">
                        </td>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/5" id="tx-body"></tbody>
            </table>
        </div>

        <!-- PAGINATION CONTROLS -->
        <div class="p-3 bg-slate-900/80 border-t border-white/5 flex justify-between items-center text-xs shrink-0" id="pagination-controls">
            <button onclick="changePage(-1)" id="btn-prev" class="btn-secondary py-1 px-3 text-[10px] disabled:opacity-50 disabled:cursor-not-allowed">
                &larr; Previous
            </button>

            <div class="flex items-center gap-4">
                <span class="text-slate-500" id="page-info">Page 1 of 1</span>
                <span class="text-slate-600 text-[10px] font-mono" id="total-count">0 entries</span>
            </div>

            <button onclick="changePage(1)" id="btn-next" class="btn-secondary py-1 px-3 text-[10px] disabled:opacity-50 disabled:cursor-not-allowed">
                Next &rarr;
            </button>
        </div>
    </div>

</div>

<!-- CATEGORY MODAL REMOVED -->

<style>
    /* Styling for the dropdowns to match the screenshot vibe */
    select.category-select {
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1em 1em;
        padding-right: 2rem; /* Space for arrow */
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }

        /* Ensure options have dark background so text is readable when opened */
        select.category-select option {
            background-color: #1e293b; /* slate-800 */
            color: white;
        }
</style>

<script>
    // Use var to avoid re-declaration errors in SPA
    var srpCharts = {};
    var CSRF_TOKEN = '{{ csrf_token }}';

    // Pagination State
    var currentPage = 1;
    var totalPages = 1;
    var searchTimer = null;

    // Cache for delayed rendering
    var cachedChartData = null;

    // --- COLOR MAPPING (Solid Bar Style) ---
    function getCategoryClass(key) {
        const map = {
            // Solid colors with white text for the selected state
            'srp_in': 'bg-green-600 border-green-500 text-white',
            'srp_out': 'bg-red-600 border-red-500 text-white',
            'internal_transfer': 'bg-purple-600 border-purple-500 text-white',
            'giveaway': 'bg-orange-600 border-orange-500 text-white',
            'manual_change': 'bg-blue-600 border-blue-500 text-white',
            'manual_out': 'bg-blue-600 border-blue-500 text-white',
            'tax': 'bg-slate-600 border-slate-500 text-white',
            'other': 'bg-slate-600 border-slate-500 text-white',
            '': 'bg-slate-800 border-slate-700 text-slate-400' // Default/Empty
        };
        return map[key] || map['other'];
    }

    function initSRPDashboard() {
        console.log("Initializing SRP Dashboard...");

        // START SYNC TIMER
        if (window.NEXT_SYNC_ISO) {
            startSyncTimer(window.NEXT_SYNC_ISO);
        }

        const startEl = document.getElementById('start-date');
        const endEl = document.getElementById('end-date');
        if (!startEl || !endEl) return;

        // Set default dates: Last day of previous month -> Last day of current month
        const now = new Date();
        const y = now.getFullYear();
        const m = now.getMonth();

        const startDate = new Date(y, m, 0);
        const endDate = new Date(y, m + 1, 0);

        const fmt = d => d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');

        startEl.value = fmt(startDate);
        endEl.value = fmt(endDate);

        loadData(1);
    }

    function debouncedLoad() {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(() => {
            loadData(1);
        }, 400);
    }

    function loadData(page = 1) {
        currentPage = page;
        const start = document.getElementById('start-date').value;
        const end = document.getElementById('end-date').value;
        const limit = document.getElementById('limit-select').value;
        const divs = Array.from(document.querySelectorAll('input[name="div"]:checked')).map(cb => cb.value);

        // Get Filter Values
        const fAmount = document.getElementById('filter-amount').value;
        const fParty = document.getElementById('filter-party').value;
        const fType = document.getElementById('filter-type').value;
        const fCat = document.getElementById('filter-category').value;
        const fReason = document.getElementById('filter-reason').value;

        const params = new URLSearchParams();
        params.append('start_date', start);
        params.append('end_date', end);
        params.append('page', page);
        params.append('limit', limit);
        divs.forEach(d => params.append('divisions[]', d));

        // Append Filters
        if(fAmount) params.append('f_amount', fAmount);
        if(fParty) params.append('f_party', fParty);
        if(fType) params.append('f_type', fType);
        if(fCat) params.append('f_category', fCat);
        if(fReason) params.append('f_reason', fReason);

        const tbody = document.getElementById('tx-body');
        if(tbody) tbody.style.opacity = '0.5';

        fetch(`{% url 'api_srp_data' %}?${params.toString()}`)
            .then(r => r.json())
            .then(data => {
                if (data.error) {
                    console.error("API Error:", data.error);
                    return;
                }

                if(tbody) tbody.style.opacity = '1';

                renderSummary(data.summary);
                renderTable(data.transactions);
                updatePagination(data.pagination);

                // Handle Charts (with lazy loading)
                cachedChartData = data;
                ensureChartsRender();
            })
            .catch(err => {
                console.error("Network Error:", err);
                if(tbody) tbody.style.opacity = '1';
            });
    }

    function updatePagination(meta) {
        if (!meta) return;

        totalPages = meta.total_pages;
        currentPage = meta.current_page;

        document.getElementById('page-info').textContent = `Page ${meta.current_page} of ${meta.total_pages}`;
        document.getElementById('total-count').textContent = `${meta.total_count} total entries`;

        document.getElementById('btn-prev').disabled = !meta.has_previous;
        document.getElementById('btn-next').disabled = !meta.has_next;
    }

    function changePage(delta) {
        const newPage = currentPage + delta;
        if (newPage > 0 && newPage <= totalPages) {
            loadData(newPage);
        }
    }

    function renderSummary(sum) {
        document.getElementById('val-income').textContent = formatISK(sum.income);
        document.getElementById('val-outcome').textContent = formatISK(sum.outcome);
        const netEl = document.getElementById('val-net');
        netEl.textContent = formatISK(sum.net);
        netEl.className = `text-2xl font-mono font-bold ${sum.net >= 0 ? 'text-green-400' : 'text-red-400'}`;
    }

    function formatISK(val) {
        return parseFloat(val).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' ISK';
    }

    // --- CHART LOADING LOGIC ---
    function ensureChartsRender() {
        if (typeof Chart !== 'undefined') {
            // Library ready, render immediately
            renderChartsInternal(cachedChartData);
        } else {
            // Library missing
            const existingScript = document.querySelector('script[src*="chart.js"]');
            if (existingScript) {
                // Script tag exists but Chart is undefined (Still Loading)
                // Poll until ready
                const checkInterval = setInterval(() => {
                    if (typeof Chart !== 'undefined') {
                        clearInterval(checkInterval);
                        if (cachedChartData) renderChartsInternal(cachedChartData);
                    }
                }, 100);
            } else {
                // Not requested yet, inject it
                console.log("Fetching Chart.js...");
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
                script.onload = () => {
                    if (cachedChartData) renderChartsInternal(cachedChartData);
                };
                document.head.appendChild(script);
            }
        }
    }

    function renderChartsInternal(data) {
        if (!data) return;
        const ctxMonthly = document.getElementById('chart-monthly');
        const ctxCat = document.getElementById('chart-cat');
        const ctxPayerC = document.getElementById('chart-payers-count');
        const ctxPayerI = document.getElementById('chart-payers-isk');

        // 1. Monthly
        const months = Object.keys(data.monthly).sort();
        updateChart('monthly', ctxMonthly, 'bar', {
            labels: months,
            datasets: [
                { label: 'In', data: months.map(m => data.monthly[m].in), backgroundColor: '#4ade80' },
                { label: 'Out', data: months.map(m => data.monthly[m].out), backgroundColor: '#f87171' }
            ]
        });

        // 2. Categories (Income)
        const cats = Object.keys(data.categories.in);
        updateChart('cat', ctxCat, 'doughnut', {
            labels: cats,
            datasets: [{
                data: cats.map(c => data.categories.in[c]),
                backgroundColor: ['#3b82f6', '#8b5cf6', '#f59e0b', '#10b981', '#ec4899'],
                borderWidth: 0
            }]
        });

        // 3. Top Payers
        const payers = Object.entries(data.top_payers).sort((a, b) => b[1].total - a[1].total).slice(0, 5);
        const pLabels = payers.map(p => p[0]);

        updateChart('payerC', ctxPayerC, 'bar', {
            labels: pLabels,
            datasets: [{ label: 'Count', data: payers.map(p => p[1].count), backgroundColor: '#38bdf8' }],
            indexAxis: 'y'
        });

        updateChart('payerI', ctxPayerI, 'bar', {
            labels: pLabels,
            datasets: [{ label: 'Total ISK', data: payers.map(p => p[1].total), backgroundColor: '#facc15' }],
            indexAxis: 'y'
        });
    }

    function updateChart(key, ctx, type, data) {
        if (!ctx) return;

        if (srpCharts[key]) {
            srpCharts[key].destroy();
        }

        srpCharts[key] = new Chart(ctx, {
            type: type,
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: data.indexAxis,
                plugins: {
                    legend: {
                        labels: { color: '#94a3b8', font: { size: 10 } },
                        position: type === 'doughnut' ? 'right' : 'top'
                    }
                },
                scales: type !== 'doughnut' ? {
                    x: { ticks: { color: '#94a3b8', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.05)' } },
                    y: { ticks: { color: '#94a3b8', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.05)' } }
                } : {
                    x: { display: false },
                    y: { display: false }
                },
                layout: { padding: 0 }
            }
        });
    }

    function renderTable(txs) {
        const body = document.getElementById('tx-body');
        if (!body) return;

        if (txs.length === 0) {
            body.innerHTML = '<tr><td colspan="8" class="p-8 text-center text-slate-500 italic">No transactions found for this period.</td></tr>';
            return;
        }

        const options = [
            { id: '', label: 'Select...' },
            { id: 'srp_in', label: 'SRP In' },
            { id: 'srp_out', label: 'SRP Out' },
            { id: 'internal_transfer', label: 'Internal Transfer' },
            { id: 'giveaway', label: 'Giveaway' },
            { id: 'manual_change', label: 'Manual Change' },
            { id: 'manual_out', label: 'Manual Out' },
            { id: 'tax', label: 'Tax' },
            { id: 'other', label: 'Other' }
        ];

        body.innerHTML = txs.map(t => {
            // Use custom category if set, else fallback
            const currentCat = t.custom_category || '';
            const style = getCategoryClass(currentCat);
            const refLabel = t.ref_type.replace(/_/g, ' ');

            // Build Options
            const optionsHtml = options.map(opt =>
                `<option value="${opt.id}" ${opt.id === currentCat ? 'selected' : ''}>${opt.label}</option>`
            ).join('');

            return `
            <tr class="hover:bg-white/5 transition group">
                <td class="p-3 font-mono text-[10px] whitespace-nowrap text-slate-500 group-hover:text-slate-300">${new Date(t.date).toLocaleDateString()} <span class="opacity-50">${new Date(t.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span></td>
                <td class="p-3 text-center"><span class="bg-white/5 px-1.5 py-0.5 rounded text-[10px] border border-white/5">${t.division}</span></td>
                <td class="p-3 text-right font-mono font-bold ${t.amount > 0 ? 'text-green-400' : 'text-red-400'} text-xs">${formatISK(t.amount)}</td>
                <td class="p-3 truncate max-w-[120px] text-slate-300" title="${t.first_party_name}">${t.first_party_name}</td>
                <td class="p-3 truncate max-w-[120px] text-slate-300" title="${t.second_party_name}">${t.second_party_name}</td>

                <!-- TYPE COLUMN -->
                <td class="p-3"><span class="badge badge-slate text-[9px] text-slate-500">${refLabel}</span></td>

                <!-- DROPDOWN CATEGORY COLUMN -->
                <td class="p-3">
                    <select class="category-select w-full ${style} rounded px-2 py-1 text-[10px] font-bold border outline-none appearance-none cursor-pointer transition-colors duration-300 focus:ring-1 focus:ring-white/50"
                            onchange="saveCategory('${t.entry_id}', this.value, this)">
                        ${optionsHtml}
                    </select>
                </td>

                <td class="p-3 truncate max-w-[200px] italic text-slate-500 text-[10px]" title="${t.reason}">${t.reason}</td>
            </tr>
        `}).join('');
    }

    function saveCategory(entryId, category, selectElement) {
        if(selectElement) {
            const newStyle = getCategoryClass(category);
            selectElement.className = `category-select w-full ${newStyle} rounded px-2 py-1 text-[10px] font-bold border outline-none appearance-none cursor-pointer transition-colors duration-300 focus:ring-1 focus:ring-white/50`;
        }

        fetch("{% url 'api_update_transaction_category' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': CSRF_TOKEN,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ entry_id: entryId, category: category })
        })
        .then(r => r.json())
        .then(d => {
            if(!d.success) {
                alert("Error updating category: " + d.error);
            }
        });
    }

    // --- SYNC TIMER LOGIC ---
    function startSyncTimer(isoDateString) {
        const timerEl = document.getElementById('next-sync-timer');
        const target = new Date(isoDateString).getTime();

        const updateTimer = () => {
            const now = new Date().getTime();
            const diff = target - now;

            if (diff <= 0) {
                timerEl.textContent = "Processing...";
                timerEl.classList.add('animate-pulse', 'text-green-400');
                timerEl.classList.remove('text-brand-400');
                return;
            }

            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            timerEl.textContent = `${minutes}m ${seconds}s`;
        };

        updateTimer(); // Run once immediately
        setInterval(updateTimer, 1000);
    }

    // --- INITIALIZATION START ---
    initSRPDashboard();
</script>
{% endblock %}