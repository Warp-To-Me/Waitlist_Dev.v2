{% extends 'management/base_management.html' %}
{% load humanize %}

{% block title %}Corp Wallet Monitor{% endblock %}

{% block management_content %}
<!-- REMOVED: h-full to prevent layout constraint issues on mobile -->
<div class="flex flex-col gap-6 animate-fade-in pb-6">

    <!-- HEADER / FILTERS -->
    <div class="glass-panel p-4 flex flex-col md:flex-row justify-between items-center gap-4 bg-slate-900/90 shrink-0">
        <div class="flex items-center gap-6">
            <div>
                <h1 class="text-lg font-bold text-white tracking-tight">Corporation Wallet Monitor</h1>
                <!-- UPDATED: Replaced static timesince with JS-controlled span -->
                <p class="text-xs text-slate-400">
                    Last Sync: <span id="last-sync-text" class="text-slate-300">Checking...</span>
                </p>
            </div>

            <!-- NEXT SYNC TIMER -->
            <div class="hidden md:flex items-center gap-2 px-3 py-1.5 rounded-lg bg-black/20 border border-white/5" id="sync-timer-container">
                <span class="text-[10px] text-slate-500 uppercase font-bold tracking-wider">Next Sync</span>
                <span class="text-xs font-mono text-slate-400 font-bold" id="next-sync-timer">Processing...</span>
            </div>
        </div>

        <div class="flex gap-4 items-center flex-wrap">
            <div class="flex items-center gap-2 bg-black/30 p-1.5 rounded border border-white/10">
                <!-- Added onchange="loadData(1)" to dates -->
                <input type="date" id="start-date" class="bg-transparent text-xs text-white outline-none" onchange="loadData(1)">
                <span class="text-slate-500">-</span>
                <input type="date" id="end-date" class="bg-transparent text-xs text-white outline-none" onchange="loadData(1)">

                <!-- ALL BUTTON -->
                <button onclick="setAllTime()" class="text-[10px] font-bold text-slate-500 hover:text-brand-400 ml-2 pl-2 border-l border-white/10 uppercase transition" title="Show All Time">
                    All
                </button>
            </div>

            <div class="flex gap-2 text-xs">
                {% for i in "1234567" %}
                <label class="flex items-center gap-1 cursor-pointer select-none">
                    <input type="checkbox" name="div" value="{{ i }}" checked onchange="loadData(1)"
                           class="rounded bg-slate-800 border-slate-600 text-brand-500 focus:ring-0 w-3 h-3">
                    <span class="text-slate-300">Div {{ i }}</span>
                </label>
                {% endfor %}
            </div>

            <!-- Removed "Apply" button since filters are live -->
            <button onclick="loadData(1)" class="btn-ghost p-1.5 text-slate-400 hover:text-white" title="Force Refresh">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
            </button>
        </div>
    </div>

    <!-- NEW: DIVISION BALANCES CONTAINER -->
    <div id="division-balances-container" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3 shrink-0 hidden">
        <!-- Injected via JS -->
    </div>

    <!-- SUMMARY CARDS -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 shrink-0">
        <div class="glass-panel p-4 text-center">
            <div class="label-text mb-1">Total Income</div>
            <div class="text-2xl font-mono font-bold text-green-400" id="val-income">...</div>
        </div>
        <div class="glass-panel p-4 text-center">
            <div class="label-text mb-1">Total Outcome</div>
            <div class="text-2xl font-mono font-bold text-red-400" id="val-outcome">...</div>
        </div>
        <div class="glass-panel p-4 text-center">
            <div class="label-text mb-1">Net Change</div>
            <div class="text-2xl font-mono font-bold text-white" id="val-net">...</div>
        </div>
    </div>

    <!-- CHARTS ROW 1 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 shrink-0">
        <div class="glass-panel p-4 flex flex-col h-80">
            <h3 class="label-text mb-2">Monthly Cashflow</h3>
            <div class="flex-grow relative min-h-0"><canvas id="chart-monthly"></canvas></div>
        </div>
        <div class="glass-panel p-4 flex flex-col h-80">
            <!-- UPDATED TITLE -->
            <h3 class="label-text mb-2">Category Breakdown (Volume)</h3>
            <div class="flex-grow relative min-h-0"><canvas id="chart-cat"></canvas></div>
        </div>
    </div>

    <!-- CHARTS ROW 2 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 shrink-0">
        <div class="glass-panel p-4 flex flex-col h-80">
            <h3 class="label-text mb-2">Top Payers (Count)</h3>
            <div class="flex-grow relative min-h-0"><canvas id="chart-payers-count"></canvas></div>
        </div>
        <div class="glass-panel p-4 flex flex-col h-80">
            <h3 class="label-text mb-2">Top Payers (ISK)</h3>
            <div class="flex-grow relative min-h-0"><canvas id="chart-payers-isk"></canvas></div>
        </div>
    </div>

    <!-- TRANSACTIONS -->
    <div class="glass-panel flex flex-col overflow-hidden min-h-[500px]">
        <div class="p-4 border-b border-white/5 bg-slate-900/50 shrink-0 flex items-center justify-between">
            <!-- Left: Title -->
            <div class="w-1/3">
                <h3 class="label-text mb-0">Recent Transactions</h3>
            </div>

            <!-- Center: Top Pagination (Compact) -->
            <div class="w-1/3 flex justify-center items-center gap-2">
                <button onclick="changePage(-1)" class="btn-prev btn-secondary py-1 px-2 text-[10px] disabled:opacity-50 disabled:cursor-not-allowed">
                    &larr;
                </button>
                <span class="text-slate-500 text-[10px] font-mono page-info-simple">1 / 1</span>
                <button onclick="changePage(1)" class="btn-next btn-secondary py-1 px-2 text-[10px] disabled:opacity-50 disabled:cursor-not-allowed">
                    &rarr;
                </button>
            </div>

            <!-- Right: Rows Selector -->
            <div class="w-1/3 flex justify-end items-center gap-2">
                <span class="text-[10px] text-slate-500 uppercase font-bold">Rows:</span>
                <select id="limit-select" onchange="loadData(1, false)" class="bg-black/30 border border-slate-700 text-slate-300 text-xs rounded px-2 py-1 outline-none focus:border-brand-500">
                    <option value="10">10</option>
                    <option value="25" selected>25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
        </div>

        <div class="overflow-auto custom-scrollbar flex-grow relative bg-slate-900/20">
            <table class="w-full text-left text-xs text-slate-400 border-collapse">
                <thead class="bg-slate-900/95 text-[10px] uppercase font-bold sticky top-0 z-10 backdrop-blur-md shadow-sm">
                    <!-- MAIN HEADER ROW -->
                    <tr>
                        <th class="px-2 py-2 border-b border-white/5 w-24 whitespace-nowrap">Date</th>
                        <th class="px-2 py-2 border-b border-white/5 text-center w-12">Div</th>
                        <th class="px-2 py-2 border-b border-white/5 text-right w-32 whitespace-nowrap">Amount</th>
                        <th class="px-2 py-2 border-b border-white/5 w-32">From</th>
                        <th class="px-2 py-2 border-b border-white/5 w-32">To</th>
                        <th class="px-2 py-2 border-b border-white/5 w-32 whitespace-nowrap">Type</th>
                        <th class="px-2 py-2 border-b border-white/5 w-48">Category</th>
                        <th class="px-2 py-2 border-b border-white/5">Reason</th>
                    </tr>
                    <!-- FILTER ROW -->
                    <tr class="bg-slate-900/90 border-b border-white/10">
                        <td class="p-1"></td>
                        <td class="p-1">
                            <input type="text" id="filter-division" class="w-full bg-black/40 border border-white/10 rounded px-1 py-0.5 text-[10px] text-center text-slate-300 placeholder-slate-600 focus:border-brand-500 outline-none" placeholder="#" onkeyup="debouncedLoad()">
                        </td>
                        <td class="p-1">
                            <input type="text" id="filter-amount" class="w-full bg-black/40 border border-white/10 rounded px-1 py-0.5 text-[10px] text-right text-slate-300 placeholder-slate-600 focus:border-brand-500 outline-none" placeholder="Min Amount..." onkeyup="debouncedLoad()">
                        </td>
                        <td class="p-1">
                            <input type="text" id="filter-from" class="w-full bg-black/40 border border-white/10 rounded px-1 py-0.5 text-[10px] text-slate-300 placeholder-slate-600 focus:border-brand-500 outline-none" placeholder="From..." onkeyup="debouncedLoad()">
                        </td>
                        <td class="p-1">
                            <input type="text" id="filter-to" class="w-full bg-black/40 border border-white/10 rounded px-1 py-0.5 text-[10px] text-slate-300 placeholder-slate-600 focus:border-brand-500 outline-none" placeholder="To..." onkeyup="debouncedLoad()">
                        </td>
                        <td class="p-1">
                            <input type="text" id="filter-type" class="w-full bg-black/40 border border-white/10 rounded px-1 py-0.5 text-[10px] text-slate-300 placeholder-slate-600 focus:border-brand-500 outline-none" placeholder="Filter Type..." onkeyup="debouncedLoad()">
                        </td>
                        <td class="p-1">
                            <select id="filter-category" class="w-full bg-black/40 border border-white/10 rounded px-1 py-0.5 text-[10px] text-slate-300 focus:border-brand-500 outline-none" onchange="loadData(1)">
                                <option value="">All Categories</option>
                                <option value="uncategorised" class="text-brand-400 font-bold">Uncategorised</option>
                                <option value="srp_in">SRP In</option>
                                <option value="srp_out">SRP Out</option>
                                <option value="internal_transfer">Internal Transfer</option>
                                <option value="giveaway">Giveaway</option>
                                <option value="manual_change">Manual Change</option>
                                <option value="manual_out">Manual Out</option>
                                <option value="tax">Tax</option>
                                <option value="other">Other</option>
                            </select>
                        </td>
                        <td class="p-1">
                            <input type="text" id="filter-reason" class="w-full bg-black/40 border border-white/10 rounded px-1 py-0.5 text-[10px] text-slate-300 placeholder-slate-600 focus:border-brand-500 outline-none" placeholder="Reason..." onkeyup="debouncedLoad()">
                        </td>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/5" id="tx-body"></tbody>
            </table>
        </div>

        <!-- PAGINATION CONTROLS (BOTTOM) -->
        <div class="p-3 bg-slate-900/80 border-t border-white/5 flex justify-center items-center text-xs shrink-0 relative" id="pagination-controls">

            <!-- Centered Navigation -->
            <div class="flex items-center gap-4">
                <button onclick="changePage(-1)" class="btn-prev btn-secondary py-1 px-3 text-[10px] disabled:opacity-50 disabled:cursor-not-allowed">
                    &larr; Previous
                </button>

                <span class="text-slate-500 page-info-detailed">Page 1 of 1</span>

                <button onclick="changePage(1)" class="btn-next btn-secondary py-1 px-3 text-[10px] disabled:opacity-50 disabled:cursor-not-allowed">
                    Next &rarr;
                </button>
            </div>

            <!-- Right-Aligned Count -->
            <div class="absolute right-4 flex items-center">
                <span class="text-slate-600 text-[10px] font-mono" id="total-count-display">0 entries</span>
            </div>
        </div>
    </div>

</div>

<style>
    select.category-select {
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1em 1em;
        padding-right: 2rem;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }

        select.category-select option {
            background-color: #1e293b;
            color: white;
        }
</style>

<script>
    var srpCharts = {};
    var CSRF_TOKEN = '{{ csrf_token }}';

    var currentPage = 1;
    var totalPages = 1;
    var searchTimer = null;
    var timerInterval = null; // Countdown Timer
    var pollingTimeout = null; // Status Poller
    var lastSyncInterval = null; // Local updater for "Time Ago" text

    // Global variable to store last sync timestamp for the local updater
    var globalLastSyncDate = null;

    var cachedChartData = null;

    function getCategoryClass(key) {
        const map = {
            'srp_in': 'bg-green-600 border-green-500 text-white',
            'srp_out': 'bg-red-600 border-red-500 text-white',
            'internal_transfer': 'bg-purple-600 border-purple-500 text-white',
            'giveaway': 'bg-orange-600 border-orange-500 text-white',
            'manual_change': 'bg-blue-600 border-blue-500 text-white',
            'manual_out': 'bg-blue-600 border-blue-500 text-white',
            'tax': 'bg-slate-600 border-slate-500 text-white',
            'other': 'bg-slate-600 border-slate-500 text-white',
            '': 'bg-slate-800 border-slate-700 text-slate-400'
        };
        return map[key] || map['other'];
    }

    function getCategoryColor(categoryLabel) {
        const label = categoryLabel.toLowerCase().replace(/\s+/g, '_');
        const colorMap = {
            'srp_in': '#16a34a',
            'srp_out': '#dc2626',
            'internal_transfer': '#9333ea',
            'giveaway': '#ea580c',
            'manual_change': '#2563eb',
            'manual_out': '#2563eb',
            'tax': '#475569',
            'other': '#475569',
            'uncategorised': '#94a3b8'
        };
        return colorMap[label] || '#475569';
    }

    function initSRPDashboard() {
        console.log("Initializing SRP Dashboard...");

        // Start polling for backend sync status
        fetchSyncStatus();

        // Start local ticker to update "Last Sync: X mins ago" text every minute
        if (lastSyncInterval) clearInterval(lastSyncInterval);
        lastSyncInterval = setInterval(updateLastSyncLabel, 60000);

        const startEl = document.getElementById('start-date');
        const endEl = document.getElementById('end-date');
        if (!startEl || !endEl) return;

        const now = new Date();
        const y = now.getFullYear();
        const m = now.getMonth();
        const startDate = new Date(y, m, 0);
        const endDate = new Date(y, m + 1, 0);
        const fmt = d => d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');

        startEl.value = fmt(startDate);
        endEl.value = fmt(endDate);

        loadData(1, true);
    }

    // --- ADAPTIVE STATUS POLLER ---
    function fetchSyncStatus() {
        if (pollingTimeout) clearTimeout(pollingTimeout);

        fetch("{% url 'api_srp_status' %}")
            .then(r => r.json())
            .then(data => {
                let nextPollDelay = 30000; // Default: 30s

                if(data.active) {
                    // 1. Update Last Sync (And store global for local ticker)
                    if(data.last_sync) {
                        globalLastSyncDate = new Date(data.last_sync);
                        updateLastSyncLabel(); // Update immediately
                    } else {
                        document.getElementById('last-sync-text').textContent = "Never";
                    }

                    // 2. Update Next Sync Timer
                    if(data.next_sync) {
                        const nextSyncTime = new Date(data.next_sync);
                        const now = new Date();
                        const diff = nextSyncTime - now;

                        document.getElementById('sync-timer-container').classList.remove('hidden');
                        document.getElementById('sync-timer-container').classList.add('flex');

                        startSyncTimer(data.next_sync);

                        // Adaptive Logic: Sleep longer if sync is far away
                        if (diff > 300000) {
                            nextPollDelay = 300000; // 5 mins
                        } else if (diff > 15000) {
                            nextPollDelay = diff; // Wake up exactly when expired
                        } else {
                            nextPollDelay = 15000; // Fast poll (15s) when expired/processing
                        }
                    }
                }

                // console.log(`Next status check in ${Math.round(nextPollDelay/1000)}s`);
                pollingTimeout = setTimeout(fetchSyncStatus, nextPollDelay);
            })
            .catch(err => {
                console.error("Error polling SRP status", err);
                pollingTimeout = setTimeout(fetchSyncStatus, 60000);
            });
    }

    // Runs locally to keep the "ago" text fresh without network calls
    function updateLastSyncLabel() {
        if (!globalLastSyncDate) return;
        const timeAgo = formatTimeAgo(globalLastSyncDate);
        const el = document.getElementById('last-sync-text');
        if(el) el.textContent = `${timeAgo} ago`;
    }

    function formatTimeAgo(date) {
        const now = new Date();
        const seconds = Math.floor((now - date) / 1000);

        if(seconds < 60) return "Just now";

        const minutes = Math.floor(seconds / 60);
        if(minutes < 60) return `${minutes}m`;

        const hours = Math.floor(minutes / 60);
        if(hours < 24) return `${hours}h ${minutes % 60}m`;

        const days = Math.floor(hours / 24);
        return `${days}d`;
    }

    function setAllTime() {
        document.getElementById('start-date').value = '';
        document.getElementById('end-date').value = '';
        loadData(1, true);
    }

    function debouncedLoad() {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(() => {
            loadData(1, true);
        }, 400);
    }

    function loadData(page = 1, updateCharts = true) {
        currentPage = page;
        const start = document.getElementById('start-date').value;
        const end = document.getElementById('end-date').value;
        const limit = document.getElementById('limit-select').value;
        const divs = Array.from(document.querySelectorAll('input[name="div"]:checked')).map(cb => cb.value);

        // Filters
        const fDiv = document.getElementById('filter-division').value;
        const fAmount = document.getElementById('filter-amount').value;
        const fFrom = document.getElementById('filter-from').value;
        const fTo = document.getElementById('filter-to').value;
        const fType = document.getElementById('filter-type').value;
        const fCat = document.getElementById('filter-category').value;
        const fReason = document.getElementById('filter-reason').value;

        const params = new URLSearchParams();
        params.append('start_date', start);
        params.append('end_date', end);
        params.append('page', page);
        params.append('limit', limit);
        divs.forEach(d => params.append('divisions[]', d));

        if(fDiv) params.append('f_div', fDiv);
        if(fAmount) params.append('f_amount', fAmount);
        if(fFrom) params.append('f_from', fFrom);
        if(fTo) params.append('f_to', fTo);
        if(fType) params.append('f_type', fType);
        if(fCat) params.append('f_category', fCat);
        if(fReason) params.append('f_reason', fReason);

        const tbody = document.getElementById('tx-body');
        if(tbody) tbody.style.opacity = '0.5';

        fetch(`{% url 'api_srp_data' %}?${params.toString()}`)
            .then(r => r.json())
            .then(data => {
                if (data.error) {
                    console.error("API Error:", data.error);
                    return;
                }

                if(tbody) tbody.style.opacity = '1';

                renderTable(data.transactions);
                updatePagination(data.pagination);

                if (updateCharts) {
                    renderSummary(data.summary);
                    renderDivisionBalances(data.division_balances);
                    cachedChartData = data;
                    ensureChartsRender();
                }
            })
            .catch(err => {
                console.error("Network Error:", err);
                if(tbody) tbody.style.opacity = '1';
            });
    }

    function renderDivisionBalances(balances) {
        const container = document.getElementById('division-balances-container');
        if (!container) return;
        container.innerHTML = '';
        if (!balances || Object.keys(balances).length === 0) {
            container.classList.add('hidden');
            return;
        }
        container.classList.remove('hidden');
        Object.keys(balances).sort().forEach(divId => {
            const balance = parseFloat(balances[divId]);
            const card = document.createElement('div');
            card.className = "glass-panel p-3 flex flex-col justify-center items-center border border-white/5 bg-slate-900/50";
            card.innerHTML = `
                <span class="text-[10px] uppercase font-bold text-slate-500 tracking-wider mb-1">Division ${divId}</span>
                <span class="text-xs font-mono font-bold text-white whitespace-nowrap">${formatISK(balance)}</span>
            `;
            container.appendChild(card);
        });
    }

    function updatePagination(meta) {
        if (!meta) return;
        totalPages = meta.total_pages;
        currentPage = meta.current_page;

        // Update Labels (Both top and bottom)
        document.querySelectorAll('.page-info-simple').forEach(el => el.textContent = `${meta.current_page} / ${meta.total_pages}`);
        document.querySelectorAll('.page-info-detailed').forEach(el => el.textContent = `Page ${meta.current_page} of ${meta.total_pages}`);

        // Update Total Count
        const countEl = document.getElementById('total-count-display');
        if(countEl) countEl.textContent = `${meta.total_count} total entries`;

        // Update Buttons (All classes)
        const prevBtns = document.querySelectorAll('.btn-prev');
        const nextBtns = document.querySelectorAll('.btn-next');

        prevBtns.forEach(btn => btn.disabled = !meta.has_previous);
        nextBtns.forEach(btn => btn.disabled = !meta.has_next);
    }

    function changePage(delta) {
        const newPage = currentPage + delta;
        if (newPage > 0 && newPage <= totalPages) {
            loadData(newPage, false);
        }
    }

    function renderSummary(sum) {
        document.getElementById('val-income').textContent = formatISK(sum.income);
        document.getElementById('val-outcome').textContent = formatISK(sum.outcome);
        const netEl = document.getElementById('val-net');
        netEl.textContent = formatISK(sum.net);
        netEl.className = `text-2xl font-mono font-bold ${sum.net >= 0 ? 'text-green-400' : 'text-red-400'}`;
    }

    function formatISK(val) {
        return parseFloat(val).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' ISK';
    }

    function ensureChartsRender() {
        if (typeof Chart !== 'undefined') {
            renderChartsInternal(cachedChartData);
        } else {
            const existingScript = document.querySelector('script[src*="chart.js"]');
            if (existingScript) {
                const checkInterval = setInterval(() => {
                    if (typeof Chart !== 'undefined') {
                        clearInterval(checkInterval);
                        if (cachedChartData) renderChartsInternal(cachedChartData);
                    }
                }, 100);
            } else {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
                script.onload = () => {
                    if (cachedChartData) renderChartsInternal(cachedChartData);
                };
                document.head.appendChild(script);
            }
        }
    }

    function renderChartsInternal(data) {
        if (!data) return;
        const ctxMonthly = document.getElementById('chart-monthly');
        const ctxCat = document.getElementById('chart-cat');
        const ctxPayerC = document.getElementById('chart-payers-count');
        const ctxPayerI = document.getElementById('chart-payers-isk');

        const months = Object.keys(data.monthly).sort();
        updateChart('monthly', ctxMonthly, 'bar', {
            labels: months,
            datasets: [
                { label: 'In', data: months.map(m => data.monthly[m].in), backgroundColor: '#4ade80' },
                { label: 'Out', data: months.map(m => data.monthly[m].out), backgroundColor: '#f87171' }
            ]
        });

        const catKeysIn = Object.keys(data.categories.in);
        const catKeysOut = Object.keys(data.categories.out);
        const allCats = Array.from(new Set([...catKeysIn, ...catKeysOut])).sort();
        const catVolumes = allCats.map(c => {
            const valIn = data.categories.in[c] || 0;
            const valOut = data.categories.out[c] || 0;
            return valIn + Math.abs(valOut);
        });
        const catColors = allCats.map(c => getCategoryColor(c));

        updateChart('cat', ctxCat, 'doughnut', {
            labels: allCats,
            datasets: [{
                data: catVolumes,
                backgroundColor: catColors,
                borderWidth: 0,
                hoverOffset: 4
            }]
        });

        const payers = Object.entries(data.top_payers).sort((a, b) => b[1].total - a[1].total).slice(0, 5);
        const pLabels = payers.map(p => p[0]);

        updateChart('payerC', ctxPayerC, 'bar', {
            labels: pLabels,
            datasets: [{ label: 'Count', data: payers.map(p => p[1].count), backgroundColor: '#38bdf8' }],
            indexAxis: 'y'
        });

        updateChart('payerI', ctxPayerI, 'bar', {
            labels: pLabels,
            datasets: [{ label: 'Total ISK', data: payers.map(p => p[1].total), backgroundColor: '#facc15' }],
            indexAxis: 'y'
        });
    }

    function updateChart(key, ctx, type, data) {
        if (!ctx) return;
        if (srpCharts[key]) srpCharts[key].destroy();
        srpCharts[key] = new Chart(ctx, {
            type: type,
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: data.indexAxis,
                plugins: {
                    legend: {
                        labels: { color: '#94a3b8', font: { size: 10 } },
                        position: type === 'doughnut' ? 'right' : 'top'
                    }
                },
                scales: type !== 'doughnut' ? {
                    x: { ticks: { color: '#94a3b8', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.05)' } },
                    y: { ticks: { color: '#94a3b8', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.05)' } }
                } : { x: { display: false }, y: { display: false } },
                layout: { padding: 0 }
            }
        });
    }

    function renderTable(txs) {
        const body = document.getElementById('tx-body');
        if (!body) return;

        if (txs.length === 0) {
            body.innerHTML = '<tr><td colspan="8" class="p-8 text-center text-slate-500 italic">No transactions found for this period.</td></tr>';
            return;
        }

        const options = [
            { id: '', label: 'Select...' },
            { id: 'srp_in', label: 'SRP In' },
            { id: 'srp_out', label: 'SRP Out' },
            { id: 'internal_transfer', label: 'Internal Transfer' },
            { id: 'giveaway', label: 'Giveaway' },
            { id: 'manual_change', label: 'Manual Change' },
            { id: 'manual_out', label: 'Manual Out' },
            { id: 'tax', label: 'Tax' },
            { id: 'other', label: 'Other' }
        ];

        body.innerHTML = txs.map(t => {
            const currentCat = t.custom_category || '';
            const style = getCategoryClass(currentCat);
            const refLabel = t.ref_type.replace(/_/g, ' ');
            const optionsHtml = options.map(opt => `<option value="${opt.id}" ${opt.id === currentCat ? 'selected' : ''}>${opt.label}</option>`).join('');

            return `
            <tr class="hover:bg-white/5 transition group">
                <td class="px-2 py-1 font-mono text-[10px] whitespace-nowrap text-slate-500 group-hover:text-slate-300">${new Date(t.date).toLocaleDateString()} <span class="opacity-50">${new Date(t.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span></td>
                <td class="px-2 py-1 text-center"><span class="bg-white/5 px-1.5 py-0.5 rounded text-[10px] border border-white/5">${t.division}</span></td>
                <td class="px-2 py-1 text-right font-mono font-bold ${t.amount > 0 ? 'text-green-400' : 'text-red-400'} text-xs whitespace-nowrap">${formatISK(t.amount)}</td>
                <td class="px-2 py-1 truncate max-w-[120px] text-slate-300" title="${t.first_party_name}">${t.first_party_name}</td>
                <td class="px-2 py-1 truncate max-w-[120px] text-slate-300" title="${t.second_party_name}">${t.second_party_name}</td>
                <td class="px-2 py-1 whitespace-nowrap"><span class="badge badge-slate text-[9px] text-slate-500">${refLabel}</span></td>
                <td class="px-2 py-1">
                    <select class="category-select w-full ${style} rounded px-1 py-0.5 text-[10px] font-bold border outline-none appearance-none cursor-pointer transition-colors duration-300 focus:ring-1 focus:ring-white/50"
                            onchange="saveCategory('${t.entry_id}', this.value, this)">
                        ${optionsHtml}
                    </select>
                </td>
                <td class="px-2 py-1 truncate max-w-[200px] italic text-slate-500 text-[10px]" title="${t.reason}">${t.reason}</td>
            </tr>
        `}).join('');
    }

    function saveCategory(entryId, category, selectElement) {
        if(selectElement) {
            const newStyle = getCategoryClass(category);
            selectElement.className = `category-select w-full ${newStyle} rounded px-1 py-0.5 text-[10px] font-bold border outline-none appearance-none cursor-pointer transition-colors duration-300 focus:ring-1 focus:ring-white/50`;
        }
        fetch("{% url 'api_update_transaction_category' %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': CSRF_TOKEN, 'Content-Type': 'application/json' },
            body: JSON.stringify({ entry_id: entryId, category: category })
        }).then(r => r.json()).then(d => { if(!d.success) alert("Error: " + d.error); });
    }

    // --- VISUAL COUNTDOWN TIMER ---
    function startSyncTimer(isoDateString) {
        if (timerInterval) clearInterval(timerInterval);
        const timerEl = document.getElementById('next-sync-timer');
        const target = new Date(isoDateString).getTime();

        const updateTimer = () => {
            const now = new Date().getTime();
            const diff = target - now;

            if (diff <= 0) {
                timerEl.textContent = "Sync Ready";
                timerEl.classList.add('animate-pulse', 'text-green-400');
                timerEl.classList.remove('text-brand-400', 'text-slate-400');
                return;
            } else {
                timerEl.classList.remove('animate-pulse', 'text-green-400', 'text-brand-400');
                timerEl.classList.add('text-slate-400');
            }

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            if (hours > 0) {
                timerEl.textContent = `${hours}h ${minutes}m ${seconds}s`;
            } else {
                timerEl.textContent = `${minutes}m ${seconds}s`;
            }
        };

        updateTimer();
        timerInterval = setInterval(updateTimer, 1000);
    }

    // --- INITIALIZATION ---
    initSRPDashboard();
</script>
{% endblock %}