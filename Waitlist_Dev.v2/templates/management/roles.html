{% extends 'management/base_management.html' %}

{% block management_content %}
<!-- REMOVED: animate-fade-in -->
<div class="flex flex-col gap-6 h-full">
    <!-- Header -->
    <div class="flex justify-between items-center border-b border-white/5 pb-6 shrink-0">
        <div>
            <h1 class="heading-1">Role Management</h1>
            <p class="text-slate-400 text-sm mt-1">Select a pilot from the directory or search to manage access rights.</p>
        </div>
    </div>

    <!-- Search Area -->
    <div class="glass-panel p-6 shrink-0">
        <div class="flex flex-col md:flex-row gap-4 max-w-4xl">

            <!-- Text Search -->
            <div class="relative flex-grow group">
                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none group-focus-within:text-brand-500 transition">
                    <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
                <input type="text"
                       id="user-search"
                       class="input-field pl-10"
                       placeholder="Search by Character Name..."
                       autocomplete="off">
            </div>

            <!-- Role Filter -->
            <div class="md:w-64">
                <select id="role-filter" class="select-field h-full">
                    <option value="">All Roles</option>
                    {% for role in roles %}
                    <option value="{{ role }}">{{ role }}</option>
                    {% endfor %}
                </select>
            </div>

        </div>
    </div>

    <!-- Content Split: Results & Editor -->
    <!-- flex-grow allows this section to expand to fill the rest of the page -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-grow items-stretch min-h-0">

        <!-- Left: Search Results / Directory List -->
        <div class="glass-panel flex flex-col overflow-hidden h-full">
            <div class="p-4 bg-white/5 border-b border-white/5">
                <h3 class="label-text mb-0">Select Pilot</h3>
            </div>

            <!-- Result Container -->
            <!-- flex-grow and overflow-y-auto ensure internal scrolling works -->
            <div id="search-results" class="divide-y divide-white/5 flex-grow overflow-y-auto custom-scrollbar">
                {% for char in page_obj %}
                <!-- Compacted padding from p-4 to p-2.5 -->
                <div class="p-2.5 hover:bg-white/5 cursor-pointer transition flex items-center gap-3 group"
                     onclick="selectPilot({{ char.user.id }}, '{{ char.character_name|escapejs }}', '{{ char.corporation_name|escapejs }}', {{ char.character_id }})">
                    <img src="https://images.evetech.net/characters/{{ char.character_id }}/portrait?size=64" class="w-8 h-8 rounded border border-white/10 group-hover:border-white transition" alt="">
                    <div>
                        <div class="text-white font-bold text-xs group-hover:text-brand-400 transition">{{ char.character_name }}</div>
                        <div class="text-[10px] text-slate-500">{{ char.corporation_name|default:"Unknown Corp" }}</div>
                    </div>
                </div>
                {% empty %}
                <div class="p-8 text-center text-slate-500 italic">No pilots found.</div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if page_obj.has_other_pages %}
            <div id="default-pagination" class="p-3 bg-white/5 border-t border-white/5 flex justify-between items-center text-xs shrink-0">
                {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}" class="btn-secondary py-1 px-2 text-[10px]">Previous</a>
                {% else %}
                <span class="px-2 py-1 bg-white/5 border border-white/5 rounded text-slate-600 cursor-not-allowed">Previous</span>
                {% endif %}

                <span class="text-slate-500 font-mono">Page {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>

                {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}" class="btn-secondary py-1 px-2 text-[10px]">Next</a>
                {% else %}
                <span class="px-2 py-1 bg-white/5 border border-white/5 rounded text-slate-600 cursor-not-allowed">Next</span>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <!-- Right: Role Editor (Hidden by default) -->
        <div id="role-editor" class="lg:col-span-2 glass-panel overflow-hidden hidden flex-col transition-all duration-300 h-full">
            <!-- Selected User Header -->
            <div class="p-6 bg-white/5 border-b border-white/5 flex items-center gap-4 shrink-0">
                <img id="editor-avatar" src="" class="w-16 h-16 rounded-lg border-2 border-white/10 shadow-lg" alt="">
                <div>
                    <h2 id="editor-name" class="text-2xl font-bold text-white tracking-tight"></h2>
                    <p id="editor-corp" class="text-slate-400 text-sm"></p>
                    <input type="hidden" id="editor-user-id" value="">
                </div>
            </div>

            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-8 overflow-y-auto custom-scrollbar flex-grow">
                <!-- Current Roles -->
                <div>
                    <h3 class="label-text flex items-center gap-2 mb-4">
                        <span class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.8)]"></span> Current Roles
                    </h3>
                    <div id="current-roles-list" class="space-y-2">
                        <!-- JS Populated -->
                    </div>
                </div>

                <!-- Available Roles -->
                <div>
                    <h3 class="label-text flex items-center gap-2 mb-4">
                        <span class="w-2 h-2 rounded-full bg-blue-500 shadow-[0_0_8px_rgba(59,130,246,0.8)]"></span> Available to Assign
                    </h3>
                    <div id="available-roles-list" class="space-y-2">
                        <!-- JS Populated -->
                    </div>
                    <p class="text-xs text-slate-500 mt-4 italic border-t border-white/5 pt-2">
                        Note: You can only assign roles that are below your own rank in the hierarchy.
                    </p>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    // Wrapped in IIFE to prevent global scope pollution and re-declaration errors on SPA navigation
    (function () {
        // --- UTILS ---
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        // --- DOM ELEMENTS (Locally scoped to this execution) ---
        const searchInput = document.getElementById('user-search');
        const roleFilter = document.getElementById('role-filter');
        const resultsContainer = document.getElementById('search-results');
        const paginationContainer = document.getElementById('default-pagination');
        const editorContainer = document.getElementById('role-editor');

        // Editor Fields
        const edName = document.getElementById('editor-name');
        const edCorp = document.getElementById('editor-corp');
        const edImg = document.getElementById('editor-avatar');
        const edId = document.getElementById('editor-user-id');
        const currentList = document.getElementById('current-roles-list');
        const availableList = document.getElementById('available-roles-list');

        // --- SEARCH LOGIC ---
        function performSearch() {
            const query = searchInput.value.trim();
            const role = roleFilter.value;

            if (query.length === 0 && role === "") {
                window.location.reload();
                return;
            }

            if (query.length > 0 && query.length < 3 && role === "") {
                resultsContainer.innerHTML = '<div class="p-8 text-center text-slate-500 italic">Type at least 3 characters...</div>';
                if (paginationContainer) paginationContainer.style.display = 'none';
                return;
            }

            const url = `{% url 'api_search_users' %}?q=${encodeURIComponent(query)}&role=${encodeURIComponent(role)}`;

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    resultsContainer.innerHTML = '';
                    if (paginationContainer) paginationContainer.style.display = 'none';

                    if (data.results.length === 0) {
                        resultsContainer.innerHTML = '<div class="p-8 text-center text-slate-500">No pilots found matching criteria.</div>';
                        return;
                    }

                    data.results.forEach(user => {
                        const el = document.createElement('div');
                        // Compacted Search Results padding here too
                        el.className = 'p-2.5 hover:bg-white/5 cursor-pointer transition flex items-center gap-3 group border-b border-white/5';
                        el.innerHTML = `
                            <img src="https://images.evetech.net/characters/${user.char_id}/portrait?size=64" class="w-8 h-8 rounded border border-white/10 group-hover:border-white transition" alt="">
                            <div>
                                <div class="text-white font-bold text-xs group-hover:text-brand-400 transition">${user.username}</div>
                                <div class="text-[10px] text-slate-500">${user.corp}</div>
                            </div>
                        `;
                        el.onclick = () => loadUserRoles(user);
                        resultsContainer.appendChild(el);
                    });
                });
        }

        if (searchInput) searchInput.addEventListener('input', debounce(performSearch, 400));
        if (roleFilter) roleFilter.addEventListener('change', performSearch);

        window.selectPilot = function (userId, charName, corpName, charId) {
            loadUserRoles({
                id: userId,
                username: charName,
                corp: corpName,
                char_id: charId
            });
        };

        // --- LOAD EDITOR ---
        function loadUserRoles(user) {
            if (edName) edName.textContent = user.username;
            if (edCorp) edCorp.textContent = user.corp;
            if (edImg) edImg.src = `https://images.evetech.net/characters/${user.char_id}/portrait?size=128`;
            if (edId) edId.value = user.id;

            if (editorContainer) {
                editorContainer.classList.remove('hidden');
                editorContainer.classList.add('flex'); // Ensure flex layout for height
            }

            refreshRoles(user.id);
        }

        function refreshRoles(userId) {
            if (currentList) currentList.innerHTML = '<div class="text-slate-500 animate-pulse text-sm">Loading...</div>';
            if (availableList) availableList.innerHTML = '<div class="text-slate-500 animate-pulse text-sm">Loading...</div>';

            fetch(`/api/mgmt/user_roles/${userId}/`)
                .then(res => res.json())
                .then(data => {
                    renderRoles(data);
                });
        }

        function renderRoles(data) {
            if (!currentList || !availableList) return;

            currentList.innerHTML = '';
            availableList.innerHTML = '';

            // Render Current
            if (data.current_roles.length === 0) {
                currentList.innerHTML = '<div class="text-sm text-slate-500 italic">No special roles assigned.</div>';
            } else {
                data.current_roles.forEach(role => {
                    const btn = document.createElement('button');
                    // Modernized Button Style
                    btn.className = "w-full text-left bg-white/5 hover:bg-red-900/20 border border-white/5 hover:border-red-500/30 p-3 rounded-lg flex justify-between items-center group transition";
                    btn.innerHTML = `
                        <span class="text-slate-200 font-bold text-sm group-hover:text-red-200">${role}</span>
                        <span class="badge badge-red opacity-0 group-hover:opacity-100 transition">Remove</span>
                    `;
                    btn.onclick = () => updateRole(data.user_id, role, 'remove');
                    currentList.appendChild(btn);
                });
            }

            // Render Available
            if (data.available_roles.length === 0) {
                availableList.innerHTML = '<div class="text-sm text-slate-500 italic">No roles available to assign.</div>';
            } else {
                data.available_roles.forEach(role => {
                    if (data.current_roles.includes(role)) return;

                    const btn = document.createElement('button');
                    // Modernized Button Style
                    btn.className = "w-full text-left bg-white/5 hover:bg-blue-900/20 border border-white/5 hover:border-blue-500/30 p-3 rounded-lg flex justify-between items-center group transition";
                    btn.innerHTML = `
                        <span class="text-slate-200 font-bold text-sm group-hover:text-blue-200">${role}</span>
                        <span class="badge badge-brand opacity-0 group-hover:opacity-100 transition">Add</span>
                    `;
                    btn.onclick = () => updateRole(data.user_id, role, 'add');
                    availableList.appendChild(btn);
                });
            }
        }

        // --- UPDATE ACTION ---
        function updateRole(userId, role, action) {
            fetch("{% url 'api_update_user_role' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    user_id: userId,
                    role: role,
                    action: action
                })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        refreshRoles(userId);
                    } else {
                        alert("Error: " + (data.error || "Unknown error"));
                    }
                })
                .catch(err => console.error("Update failed", err));
        }
    })();
</script>
{% endblock %}