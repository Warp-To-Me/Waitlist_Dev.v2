{% extends 'management/base_management.html' %}

{% block management_content %}
<!-- Note: The script tag for Chart.js has been moved inside the logic below to prevent SPA race conditions -->
<!-- REMOVED: animate-fade-in from here -->
<div class="flex flex-col gap-6">
    <!-- HEADER -->
    <div class="flex justify-between items-end border-b border-white/5 pb-6">
        <div>
            <h1 class="heading-1">Analytics Dashboard</h1>
            <p class="text-slate-400 text-sm mt-1">Real-time platform statistics</p>
        </div>
        <div class="flex gap-2">
            <button onclick="location.reload()" class="btn-secondary text-xs py-1.5">
                Refresh Data
            </button>
        </div>
    </div>

    <!-- TOP ROW: KPIs -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Users Card -->
        <div class="glass-panel p-6 relative overflow-hidden group">
            <div class="absolute -right-6 -top-6 w-24 h-24 bg-blue-500/20 rounded-full blur-xl group-hover:bg-blue-500/30 transition duration-500"></div>
            <h3 class="label-text mb-2">Total Users</h3>
            <div class="flex items-baseline gap-2 relative z-10">
                <span class="text-4xl font-bold text-white">{{ total_users }}</span>
                <span class="badge badge-green flex items-center gap-1">
                    <span>▲</span> Live
                </span>
            </div>
            <div class="w-full bg-dark-900/50 h-1 mt-4 rounded-full overflow-hidden">
                <div class="bg-blue-500 h-full w-[75%] shadow-[0_0_10px_rgba(59,130,246,0.5)]"></div>
            </div>
        </div>

        <!-- Characters Card -->
        <div class="glass-panel p-6 relative overflow-hidden group">
            <div class="absolute -right-6 -top-6 w-24 h-24 bg-purple-500/20 rounded-full blur-xl group-hover:bg-purple-500/30 transition duration-500"></div>
            <h3 class="label-text mb-2">Linked Pilots</h3>
            <div class="flex items-baseline gap-2 relative z-10">
                <span class="text-4xl font-bold text-white">{{ total_characters }}</span>
            </div>
            <div class="w-full bg-dark-900/50 h-1 mt-4 rounded-full overflow-hidden">
                <div class="bg-purple-500 h-full w-[60%] shadow-[0_0_10px_rgba(168,85,247,0.5)]"></div>
            </div>
        </div>

        <!-- Active Fleets -->
        <div class="glass-panel p-6 relative overflow-hidden group">
            <div class="absolute -right-6 -top-6 w-24 h-24 bg-brand-500/20 rounded-full blur-xl group-hover:bg-brand-500/30 transition duration-500"></div>
            <h3 class="label-text mb-2">Active Fleets</h3>
            <div class="flex items-baseline gap-2 relative z-10">
                <span class="text-4xl font-bold text-white">{{ active_fleets_count }}</span>
                <span class="text-xs text-slate-500">/ {{ total_fleets }} Total</span>
            </div>
            <div class="w-full bg-dark-900/50 h-1 mt-4 rounded-full overflow-hidden">
                <div class="bg-brand-500 h-full shadow-[0_0_10px_rgba(245,158,11,0.5)]" style="width: {% widthratio active_fleets_count total_fleets 100 %}%"></div>
            </div>
        </div>

        <!-- Efficiency Metric (Mock) -->
        <div class="glass-panel p-6 relative overflow-hidden group">
            <div class="absolute -right-6 -top-6 w-24 h-24 bg-green-500/20 rounded-full blur-xl group-hover:bg-green-500/30 transition duration-500"></div>
            <h3 class="label-text mb-2">System Uptime</h3>
            <div class="flex items-baseline gap-2 relative z-10">
                <span class="text-4xl font-bold text-white">99.9%</span>
            </div>
            <div class="w-full bg-dark-900/50 h-1 mt-4 rounded-full overflow-hidden">
                <div class="bg-green-500 h-full w-full shadow-[0_0_10px_rgba(34,197,94,0.5)]"></div>
            </div>
        </div>
    </div>

    <!-- MAIN CHART ROW -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- LINE CHART: ACTIVITY -->
        <div class="lg:col-span-2 glass-panel p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-white font-bold text-lg flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-blue-500 shadow-[0_0_8px_rgba(59,130,246,0.8)]"></span>
                    User Registration History
                </h3>
                <div class="flex gap-2">
                    <span class="badge badge-slate">Last 30 Days</span>
                </div>
            </div>
            <div class="relative w-full h-72">
                <canvas id="growthChart"></canvas>
            </div>
        </div>

        <!-- DOUGHNUT CHART: DEMOGRAPHICS -->
        <div class="glass-panel p-6 flex flex-col">
            <h3 class="text-white font-bold text-lg flex items-center gap-2 mb-6">
                <span class="w-2 h-2 rounded-full bg-purple-500 shadow-[0_0_8px_rgba(168,85,247,0.8)]"></span>
                Top Corporations
            </h3>
            <div class="relative flex-grow flex items-center justify-center h-64">
                <canvas id="corpChart"></canvas>
            </div>
            <div class="mt-4 text-center">
                <p class="label-text normal-case">Distribution by Pilot Count</p>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. Define the initialization function
    function initDashboardCharts() {
        console.log("Initializing Dashboard Charts...");

        // --- COMMON CHART CONFIG ---
        Chart.defaults.color = '#94a3b8';
        Chart.defaults.font.family = 'Inter, ui-sans-serif, system-ui';
        Chart.defaults.scale.grid.color = 'rgba(255, 255, 255, 0.05)'; // Subtle grid
        Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(15, 23, 42, 0.9)'; // Dark 900
        Chart.defaults.plugins.tooltip.borderColor = 'rgba(255, 255, 255, 0.1)';
        Chart.defaults.plugins.tooltip.borderWidth = 1;
        Chart.defaults.plugins.tooltip.padding = 10;
        Chart.defaults.plugins.tooltip.titleColor = '#f8fafc';
        Chart.defaults.plugins.tooltip.bodyColor = '#cbd5e1';
        Chart.defaults.plugins.tooltip.cornerRadius = 8;

        // --- LINE CHART (Growth) ---
        const growthEl = document.getElementById('growthChart');
        if (growthEl) {
            const ctxGrowth = growthEl.getContext('2d');

            // Create Gradient
            const gradient = ctxGrowth.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)'); // Blue top
            gradient.addColorStop(1, 'rgba(59, 130, 246, 0.0)'); // Transparent bottom

            new Chart(ctxGrowth, {
                type: 'line',
                data: {
                    labels: {{ growth_labels|safe }},
                    datasets: [{
                        label: 'New Users',
                        data: {{ growth_data|safe }},
                        borderColor: '#3b82f6',
                        backgroundColor: gradient,
                        borderWidth: 3,
                        tension: 0.4, // Smooth curves
                        pointBackgroundColor: '#0f172a',
                        pointBorderColor: '#3b82f6',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { borderDash: [5, 5] }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // --- DOUGHNUT CHART (Corps) ---
        const corpEl = document.getElementById('corpChart');
        if (corpEl) {
            const ctxCorp = corpEl.getContext('2d');
            new Chart(ctxCorp, {
                type: 'doughnut',
                data: {
                    labels: {{ corp_labels|safe }},
                    datasets: [{
                        data: {{ corp_data|safe }},
                        backgroundColor: [
                            '#3b82f6', // Blue
                            '#8b5cf6', // Purple
                            '#f59e0b', // Amber
                            '#10b981', // Emerald
                            '#ec4899'  // Pink
                        ],
                        borderColor: '#1e293b', // Match card bg for clean separation
                        borderWidth: 2,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%', // Thinner ring
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                boxWidth: 8
                            }
                        }
                    }
                }
            });
        }
    }

    // 2. Load Check Logic
    if (typeof Chart !== 'undefined') {
        initDashboardCharts();
    } else {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
        script.onload = () => {
            initDashboardCharts();
        };
        document.head.appendChild(script);
    }
</script>
{% endblock %}