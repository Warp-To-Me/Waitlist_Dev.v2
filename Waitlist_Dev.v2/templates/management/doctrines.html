{% extends 'management/base_management.html' %}

{% block management_content %}
<!-- REMOVED: animate-fade-in from here -->
<div class="flex flex-col gap-6">
    <!-- Header -->
    <div class="flex justify-between items-center border-b border-white/5 pb-6">
        <h1 class="heading-1">Doctrine Management</h1>
        <div class="flex gap-2">
            <button onclick="exportDoctrines()" class="btn-secondary text-xs border-brand-500/30 text-brand-400 hover:bg-brand-500/10">
                <span>📤</span> Export Doctrines
            </button>
            <button onclick="openImportModal()" class="btn-secondary text-xs hover:text-white">
                <span>📥</span> Import
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">

        <!-- LEFT: Create/Edit Form -->
        <div class="glass-panel p-6 h-fit sticky top-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-bold text-brand-500 tracking-wide" id="form-title">Import Fit</h2>
                <button onclick="resetForm()" id="cancel-btn" class="hidden text-xs text-red-400 hover:text-white underline decoration-red-500/30 hover:decoration-white transition">Cancel Edit</button>
            </div>

            <form method="POST" action="{% url 'manage_doctrines' %}" id="doctrine-form" class="space-y-4">
                {% csrf_token %}
                <input type="hidden" name="action" id="form-action" value="create">
                <input type="hidden" name="fit_id" id="fit_id" value="">

                <div>
                    <label class="label-text">Category</label>
                    <select name="category_id" id="category_id" class="select-field">
                        {% for cat in categories %}
                        <!-- LEVEL 0: Root -->
                        <option value="{{ cat.id }}" class="font-bold bg-slate-900">{{ cat.name }}</option>

                        <!-- LEVEL 1 -->
                        {% for l1 in cat.subcategories.all %}
                        <option value="{{ l1.id }}" class="bg-slate-800">-- {{ l1.name }}</option>

                        <!-- LEVEL 2 -->
                        {% for l2 in l1.subcategories.all %}
                        <option value="{{ l2.id }}" class="bg-slate-800">---- {{ l2.name }}</option>

                        <!-- LEVEL 3 -->
                        {% for l3 in l2.subcategories.all %}
                        <option value="{{ l3.id }}" class="bg-slate-800">------ {{ l3.name }}</option>
                        {% endfor %}
                        {% endfor %}
                        {% endfor %}
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="label-text">EFT Block</label>
                    <textarea name="eft_paste" id="eft_paste" rows="8" class="input-field font-mono text-xs" placeholder="[Hull Name, Fit Name]..."></textarea>
                    <p class="text-[10px] text-slate-500 mt-1 pl-1">Accepts EFT/Pyfa formats.</p>
                </div>

                <div>
                    <label class="label-text">Tags / Labels</label>
                    <div class="flex flex-wrap gap-2 p-3 rounded-lg border border-white/5 bg-black/20">
                        {% for tag in tags %}
                        <label class="cursor-pointer">
                            <input type="checkbox" name="tags" value="{{ tag.id }}" class="peer sr-only tag-checkbox">
                            <span class="px-2 py-1 rounded text-[10px] font-bold border border-slate-700 bg-slate-800 text-slate-400 peer-checked:border-brand-500 peer-checked:text-brand-400 peer-checked:bg-brand-900/20 transition select-none block hover:border-slate-500">
                                {{ tag.name }}
                            </span>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <div>
                    <label class="label-text">Internal Notes</label>
                    <input type="text" name="description" id="description" class="input-field">
                </div>

                <button type="submit" id="submit-btn" class="btn-primary w-full shadow-lg shadow-brand-500/20">
                    Parse & Save
                </button>
            </form>
        </div>

        <!-- RIGHT: List of Fits -->
        <div class="lg:col-span-2 glass-panel overflow-hidden">
            <div class="p-4 bg-white/5 border-b border-white/5">
                <h3 class="font-bold text-slate-200">Existing Fits</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-400">
                    <thead class="text-xs uppercase bg-white/5 text-slate-300 font-bold">
                        <tr>
                            <th class="px-6 py-3">Hull</th>
                            <th class="px-6 py-3">Fit Name</th>
                            <th class="px-6 py-3">Category</th>
                            <th class="px-6 py-3">Tags</th>
                            <th class="px-6 py-3 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-white/5">
                        {% for fit in fits %}
                        <tr class="hover:bg-white/5 transition group">
                            <td class="px-6 py-4 font-bold text-white">{{ fit.ship_type.type_name }}</td>
                            <td class="px-6 py-4">{{ fit.name }}</td>
                            <td class="px-6 py-4">
                                <!-- Deep Hierarchical Breadcrumb -->
                                {% if fit.category.parent.parent.parent %}
                                <span class="opacity-50 text-[10px]">{{ fit.category.parent.parent.parent.name }} > </span>
                                {% endif %}
                                {% if fit.category.parent.parent %}
                                <span class="opacity-50 text-[10px]">{{ fit.category.parent.parent.name }} > </span>
                                {% endif %}
                                {% if fit.category.parent %}
                                <span class="opacity-50">{{ fit.category.parent.name }} > </span>
                                {% endif %}
                                {{ fit.category.name }}
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex flex-wrap gap-1">
                                    {% for tag in fit.tags.all %}
                                    <span class="badge badge-slate text-[10px]">
                                        {{ tag.name }}
                                    </span>
                                    {% empty %}
                                    <span class="text-slate-600 text-[10px]">-</span>
                                    {% endfor %}
                                </div>
                            </td>
                            <td class="px-6 py-4 text-right flex justify-end items-center gap-2">
                                <!-- EDIT BUTTON -->
                                <button onclick="editFit(
                                    '{{ fit.id }}',
                                    '{{ fit.category.id }}',
                                    `{{ fit.eft_format|escapejs }}`,
                                    `{{ fit.description|escapejs }}`,
                                    [{% for t in fit.tags.all %}{{ t.id }},{% endfor %}]
                                )" class="btn-secondary py-1 px-2 text-[10px] border-blue-500/30 text-blue-400 hover:bg-blue-500/10">
                                    EDIT
                                </button>

                                <!-- DELETE FORM -->
                                <form method="POST" onsubmit="return confirm('Are you sure?');" class="contents">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="delete">
                                    <input type="hidden" name="fit_id" value="{{ fit.id }}">
                                    <button type="submit" class="btn-danger py-1 px-2 text-[10px]">DEL</button>
                                </form>
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="5" class="p-8 text-center italic text-slate-500">No fits found.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- EXPORT MODAL -->
<div id="export-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-dark-950/80 backdrop-blur-sm px-4">
    <div class="bg-slate-900 border border-white/10 rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden transform transition-all scale-95 opacity-0" id="export-modal-panel">
        <div class="glass-header px-6 py-4 border-b border-white/5 flex justify-between items-center">
            <h3 class="font-bold text-white text-lg">Export Doctrines</h3>
            <button onclick="closeModal('export-modal')" class="text-slate-400 hover:text-white">✕</button>
        </div>
        <div class="p-6">
            <p class="text-slate-400 text-sm mb-4">Copy this string to import into another instance. Includes categories, tags, and fits.</p>
            <textarea id="export-textarea" class="w-full bg-black/30 border border-slate-700 rounded p-3 text-xs font-mono text-brand-400 h-32 focus:ring-1 focus:ring-brand-500 outline-none resize-none" readonly></textarea>
            <div class="flex justify-end gap-2 mt-4">
                <button onclick="closeModal('export-modal')" class="btn-ghost text-xs">Close</button>
                <button onclick="copyExport()" class="btn-primary text-xs px-6">Copy to Clipboard</button>
            </div>
        </div>
    </div>
</div>

<!-- IMPORT MODAL -->
<div id="import-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-dark-950/80 backdrop-blur-sm px-4">
    <div class="bg-slate-900 border border-white/10 rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden transform transition-all scale-95 opacity-0" id="import-modal-panel">
        <div class="glass-header px-6 py-4 border-b border-white/5 flex justify-between items-center">
            <h3 class="font-bold text-white text-lg">Import Doctrines</h3>
            <button onclick="closeModal('import-modal')" class="text-slate-400 hover:text-white">✕</button>
        </div>
        <div class="p-6">
            <div class="bg-amber-900/20 border border-amber-500/30 p-3 rounded text-amber-200 text-xs mb-4 flex items-start gap-2">
                <span class="text-lg">⚠️</span>
                <p><strong>Warning:</strong> Importing doctrines will <u class="font-bold text-white">WIPE</u> all existing categories, tags, and fits. Ensure SDE data is loaded first.</p>
            </div>
            <textarea id="import-textarea" class="w-full bg-black/30 border border-slate-700 rounded p-3 text-xs font-mono text-white h-32 focus:ring-1 focus:ring-brand-500 outline-none resize-none" placeholder="Paste export string here..."></textarea>
            <div class="flex justify-end gap-2 mt-4">
                <button onclick="closeModal('import-modal')" class="btn-ghost text-xs">Cancel</button>
                <button onclick="submitImport()" id="btn-submit-import" class="btn-primary text-xs px-6">Import & Overwrite</button>
            </div>
        </div>
    </div>
</div>

<script>
    var CSRF_TOKEN = '{{ csrf_token }}';

    function editFit(id, categoryId, eftText, description, tagIds) {
        // 1. Populate Fields
        document.getElementById('fit_id').value = id;
        document.getElementById('category_id').value = categoryId;
        document.getElementById('eft_paste').value = eftText;
        document.getElementById('description').value = description;

        // 2. Set Tags
        const checkboxes = document.querySelectorAll('.tag-checkbox');
        checkboxes.forEach(cb => {
            cb.checked = tagIds.includes(parseInt(cb.value));
        });

        // 3. Change Mode to Update
        document.getElementById('form-action').value = 'update';

        const btn = document.getElementById('submit-btn');
        btn.textContent = 'Update Fit';
        // Swap Brand (Amber) style for Blue style to indicate Edit Mode
        btn.classList.remove('btn-primary', 'shadow-brand-500/20');
        btn.classList.add('bg-blue-600', 'hover:bg-blue-500', 'text-white', 'shadow-lg', 'shadow-blue-500/20', 'btn');

        const title = document.getElementById('form-title');
        title.textContent = 'Edit Fit';
        title.classList.remove('text-brand-500');
        title.classList.add('text-blue-500');

        document.getElementById('cancel-btn').classList.remove('hidden');

        // 4. Scroll Up
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function resetForm() {
        document.getElementById('doctrine-form').reset();
        document.getElementById('fit_id').value = '';
        document.getElementById('form-action').value = 'create';

        const btn = document.getElementById('submit-btn');
        btn.textContent = 'Parse & Save';
        // Reset to original Master Design class
        btn.classList.remove('bg-blue-600', 'hover:bg-blue-500', 'text-white', 'shadow-lg', 'shadow-blue-500/20', 'btn');
        btn.classList.add('btn-primary', 'shadow-brand-500/20');

        const title = document.getElementById('form-title');
        title.textContent = 'Import Fit';
        title.classList.add('text-brand-500');
        title.classList.remove('text-blue-500');

        document.getElementById('cancel-btn').classList.add('hidden');
    }

    // --- IMPORT / EXPORT LOGIC ---

    function openModal(id) {
        const modal = document.getElementById(id);
        const panel = document.getElementById(id + '-panel');
        modal.classList.remove('hidden');
        setTimeout(() => {
            panel.classList.remove('scale-95', 'opacity-0');
            panel.classList.add('scale-100', 'opacity-100');
        }, 10);
    }

    function closeModal(id) {
        const modal = document.getElementById(id);
        const panel = document.getElementById(id + '-panel');
        panel.classList.remove('scale-100', 'opacity-100');
        panel.classList.add('scale-95', 'opacity-0');
        setTimeout(() => { modal.classList.add('hidden'); }, 200);
    }

    function exportDoctrines() {
        fetch("{% url 'api_export_doctrines' %}")
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    const txt = document.getElementById('export-textarea');
                    txt.value = data.export_string;
                    openModal('export-modal');
                } else {
                    alert("Export failed: " + data.error);
                }
            })
            .catch(e => alert("Network error during export."));
    }

    function copyExport() {
        const txt = document.getElementById('export-textarea');
        txt.select();
        navigator.clipboard.writeText(txt.value);
        alert("Copied to clipboard!");
    }

    function openImportModal() {
        document.getElementById('import-textarea').value = '';
        openModal('import-modal');
    }

    function submitImport() {
        const str = document.getElementById('import-textarea').value.trim();
        if (!str) return alert("Please paste the import string.");

        const btn = document.getElementById('btn-submit-import');
        const orig = btn.textContent;
        btn.textContent = "Importing...";
        btn.disabled = true;

        fetch("{% url 'api_import_doctrines' %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': CSRF_TOKEN, 'Content-Type': 'application/json' },
            body: JSON.stringify({ import_string: str })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                closeModal('import-modal');
                location.reload();
            } else {
                alert("Import failed: " + data.error);
            }
            btn.textContent = orig;
            btn.disabled = false;
        })
        .catch(e => {
            alert("Network error during import.");
            btn.textContent = orig;
            btn.disabled = false;
        });
    }
</script>
{% endblock %}