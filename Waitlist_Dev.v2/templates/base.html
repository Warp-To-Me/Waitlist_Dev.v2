<!DOCTYPE html>
<html lang="en" class="h-full bg-[#0B1120]">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Fleet Command{% endblock %}</title>

    <!-- 1. MODERN FONT: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <!-- 2. TAILWIND CDN WITH PLUGIN SUPPORT -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 3. MASTER DESIGN CONFIGURATION -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        // Custom Brand Palette
                        brand: {
                            50: '#fffbeb',
                            100: '#fef3c7',
                            200: '#fde68a',
                            300: '#fcd34d',
                            400: '#fbbf24',
                            500: '#f59e0b', // Base Amber
                            600: '#d97706',
                            700: '#b45309',
                            800: '#92400e',
                            900: '#78350f',
                            950: '#451a03',
                        },
                        dark: {
                            800: '#1e293b',
                            900: '#0f172a',
                            950: '#020617', // Deepest background
                        }
                    }
                }
            }
        }
    </script>

    <!-- 4. REUSABLE COMPONENT CLASSES (THE "MASTER" STYLES) -->
    <style type="text/tailwindcss">
        @layer utilities {
            /* Hides scrollbar but allows scrolling */
            .no-scrollbar::-webkit-scrollbar {
                display: none;
            }

            .no-scrollbar {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }

            /* Custom Scrollbar for modern look */
            .custom-scrollbar::-webkit-scrollbar {
                width: 6px;
                height: 6px;
            }

            .custom-scrollbar::-webkit-scrollbar-track {
                @apply bg-dark-900;
            }

            .custom-scrollbar::-webkit-scrollbar-thumb {
                @apply bg-slate-700 rounded-full hover:bg-slate-600 transition;
            }
        }

        @layer components {
            /* --- LAYOUTS --- */
            .glass-panel {
                @apply bg-slate-900/60 backdrop-blur-md border border-white/10 rounded-xl shadow-xl;
            }

            .glass-header {
                @apply bg-slate-900/80 backdrop-blur-lg border-b border-white/5;
            }

            /* --- BUTTONS --- */
            .btn {
                @apply px-4 py-2 rounded-lg font-bold transition-all duration-200 flex items-center justify-center gap-2 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed;
            }

            .btn-primary {
                @apply btn bg-gradient-to-r from-brand-500 to-brand-600 text-white shadow-lg shadow-brand-500/20 hover:shadow-brand-500/40 hover:brightness-110 border border-white/10;
            }

            .btn-secondary {
                @apply btn bg-slate-800 text-slate-300 border border-slate-700 hover:bg-slate-700 hover:text-white hover:border-slate-600;
            }

            .btn-danger {
                @apply btn bg-red-900/20 text-red-400 border border-red-900/50 hover:bg-red-900/40 hover:text-red-300;
            }

            .btn-success {
                @apply btn bg-green-600 hover:bg-green-500 text-white shadow-lg shadow-green-900/20;
            }

            .btn-ghost {
                @apply btn bg-transparent hover:bg-white/5 text-slate-400 hover:text-white;
            }

            /* --- TEXT --- */
            .heading-1 {
                @apply text-3xl md:text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-white to-slate-400 tracking-tight;
            }

            .label-text {
                @apply block text-slate-400 text-xs font-bold uppercase tracking-wider mb-2;
            }

            /* --- FORMS --- */
            .input-field {
                @apply w-full bg-dark-950/50 border border-slate-700 rounded-lg p-3 text-white focus:border-brand-500 focus:ring-1 focus:ring-brand-500 outline-none transition placeholder-slate-600 font-mono text-sm;
            }

            .select-field {
                @apply w-full bg-dark-950/50 border border-slate-700 rounded-lg p-2.5 text-white focus:border-brand-500 outline-none transition appearance-none;
            }

            /* --- BADGES --- */
            .badge {
                @apply px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide border;
            }

            .badge-brand {
                @apply bg-brand-900/20 text-brand-400 border-brand-500/30;
            }

            .badge-green {
                @apply bg-green-900/20 text-green-400 border-green-500/30;
            }

            .badge-red {
                @apply bg-red-900/20 text-red-400 border-red-500/30;
            }

            .badge-slate {
                @apply bg-slate-800 text-slate-400 border-slate-700;
            }

            /* --- ANIMATION UTILITY --- */
            /* UPDATED: Added will-change for performance */
            .animate-fade-in {
                animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
                will-change: transform, opacity;
            }
        }

        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            background-image: radial-gradient(circle at 50% 0%, #1e293b 0%, #020617 60%);
            background-attachment: fixed;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
    {% block extra_head %}{% endblock %}
</head>
<body class="h-full flex flex-col overflow-hidden text-slate-300">
    <!-- Persistent Navbar -->
    <nav class="glass-header z-50 flex-shrink-0 relative">
        <div class="container mx-auto px-4 h-16 flex justify-between items-center">

            <!-- Left: Brand -->
            <div class="flex items-center gap-8">
                <a href="{% url 'landing_page' %}" class="spa-link flex items-center gap-3 group">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-brand-400 to-brand-600 flex items-center justify-center text-dark-950 font-bold text-xl shadow-lg shadow-brand-500/20 group-hover:scale-105 transition">W</div>
                    <span class="text-xl font-bold text-white tracking-tight group-hover:text-brand-400 transition">WarpToMe</span>
                </a>

                {% if user.is_staff or user.is_superuser %}
                <span class="badge badge-red hidden md:inline-block">System Admin</span>
                {% endif %}

                <!-- Desktop Menu -->
                <div class="hidden md:flex items-center gap-1 border-l border-white/10 pl-6 h-8">
                    <a href="{% url 'doctrine_list' %}" class="spa-link px-3 py-1.5 rounded-md text-sm font-medium text-slate-400 hover:text-white hover:bg-white/5 transition">
                        Doctrines
                    </a>
                </div>
            </div>

            <!-- Right: User Controls -->
            <div class="flex items-center gap-3">
                {% if user.is_authenticated %}
                {% if navbar_char %}
                <a href="{% url 'profile' %}" class="spa-link flex items-center gap-3 pl-1 pr-3 py-1 rounded-full border border-slate-700/50 bg-slate-800/50 hover:bg-slate-700 hover:border-brand-500/50 transition group">
                    <img src="https://images.evetech.net/characters/{{ navbar_char.character_id }}/portrait?size=64" class="w-8 h-8 rounded-full border border-slate-600 group-hover:border-brand-400 transition" alt="Portrait">
                    <div class="flex flex-col text-left">
                        <span class="text-xs font-bold text-white leading-none">{{ navbar_char.character_name }}</span>
                        <span class="text-[10px] leading-none mt-0.5 {% if navbar_char.is_main %}text-brand-400{% else %}text-slate-500{% endif %}">
                            {% if navbar_char.is_main %}MAIN{% else %}ALT{% endif %}
                        </span>
                    </div>
                </a>
                {% endif %}

                <div class="flex items-center gap-2 pl-2 border-l border-white/10 ml-2">
                    {% if user_is_management %}
                    <a href="{% url 'custom_admin' %}" class="spa-link btn-ghost p-2" title="Management Console">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" /></svg>
                    </a>
                    {% endif %}
                    <a href="{% url 'logout' %}" data-no-spa class="btn-ghost text-xs font-bold uppercase tracking-wider">Logout</a>
                </div>
                {% else %}
                <a href="{% url 'sso_login' %}" data-no-spa class="btn-primary py-1.5 text-sm">
                    <span>Log In</span>
                </a>
                {% endif %}
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 relative overflow-hidden flex flex-col" id="main-content">
        {% block content %}{% endblock %}
    </main>

    <!-- ESI RATE LIMIT MONITOR (FIXED BOTTOM RIGHT) -->
    <div id="esi-monitor" class="fixed bottom-4 right-4 z-50 flex flex-col gap-2 items-end pointer-events-none">
        <!-- Bars will be injected here via JS -->
    </div>

    <!-- SPA Router & Monitor Script -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            initESIMonitor(); // Init Websocket

            Array.from(document.body.childNodes).forEach(node => {
                if (node.nodeType === Node.TEXT_NODE && !node.textContent.trim()) { node.remove(); }
            });

            document.body.addEventListener('click', e => {
                const link = e.target.closest('a');
                if (link && link.href && link.host === window.location.host && !link.target && !link.hasAttribute('download') && !link.href.includes('/admin/') && !link.hasAttribute('data-no-spa')) {
                    e.preventDefault();
                    navigateTo(link.href);
                }
            });

            window.addEventListener('popstate', () => { navigateTo(window.location.href, false); });
        });

        function navigateTo(url, push = true) {
            if (push) history.pushState(null, null, url);
            fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(response => response.text())
                .then(html => {
                    const mainContent = document.getElementById('main-content');
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;

                    const newContent = tempDiv.firstElementChild;
                    if (newContent) {
                        newContent.classList.remove('animate-fade-in');
                        newContent.classList.add('opacity-0');
                    }

                    while (mainContent.firstChild) mainContent.removeChild(mainContent.firstChild);
                    while (tempDiv.firstChild) mainContent.appendChild(tempDiv.firstChild);

                    if (newContent) {
                        void newContent.offsetWidth;
                        newContent.classList.remove('opacity-0');
                        newContent.classList.add('animate-fade-in');
                    }

                    mainContent.querySelectorAll('script').forEach(oldScript => {
                        const newScript = document.createElement('script');
                        Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                        newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                        oldScript.parentNode.replaceChild(newScript, oldScript);
                    });
                })
                .catch(err => console.error('SPA Navigation Error:', err));
        }

        // --- ESI MONITOR LOGIC ---
        function initESIMonitor() {
            // Only connect if user is authenticated
            {% if user.is_authenticated %}
            const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
            const socket = new WebSocket(protocol + window.location.host + '/ws/user/notify/');
            const container = document.getElementById('esi-monitor');

            socket.onmessage = function (e) {
                const msg = JSON.parse(e.data);
                if (msg.type === 'ratelimit') {
                    updateRateLimitBar(container, msg);
                }
            };

            socket.onclose = function () {
                console.log("Notification socket closed. Retrying in 5s...");
                setTimeout(initESIMonitor, 5000);
            };
            {% endif %}
        }

        function updateRateLimitBar(container, data) {
            // Data: { bucket: "fleet", remaining: 1799, limit: 1800, window: "15m" }
            const id = `bucket-${data.bucket.replace(/\s+/g, '-')}`;
            let el = document.getElementById(id);

            // Calculate Percentage
            const percent = (data.remaining / data.limit) * 100;

            // Color Logic
            let colorClass = 'bg-green-500';
            if (percent < 50) colorClass = 'bg-yellow-500';
            if (percent < 20) colorClass = 'bg-red-500';

            const html = `
                    <div class="flex justify-between items-end mb-1">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">${data.bucket.toUpperCase()}</span>
                        <span class="text-[10px] font-mono text-white font-bold ml-4">${data.remaining}</span>
                    </div>
                    <div class="w-full h-1.5 bg-dark-900 rounded-full overflow-hidden border border-white/10">
                        <div class="h-full ${colorClass} transition-all duration-500 ease-out shadow-[0_0_8px_rgba(255,255,255,0.2)]" style="width: ${percent}%"></div>
                    </div>
                `;

            if (!el) {
                el = document.createElement('div');
                el.id = id;
                el.className = "bg-slate-900/90 backdrop-blur border border-white/10 p-2 rounded-lg shadow-xl w-48 transition-all duration-300 transform translate-x-full opacity-0 pointer-events-auto";
                container.appendChild(el);

                // Animate In
                requestAnimationFrame(() => {
                    el.classList.remove('translate-x-full', 'opacity-0');
                });
            }

            el.innerHTML = html;

            // Reset removal timer
            if (el.dataset.timer) clearTimeout(el.dataset.timer);

            // Auto-hide after 30 seconds of inactivity
            el.dataset.timer = setTimeout(() => {
                el.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => { if (el.parentNode) el.remove(); }, 500);
            }, 30000);
        }
    </script>
</body>
</html>