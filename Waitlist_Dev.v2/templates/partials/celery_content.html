{% load humanize %}

<!-- ESI HEALTH STATUS (Top Section) -->
<div class="glass-panel p-6 relative overflow-hidden group mb-6">
    <div class="absolute -right-10 -top-10 w-40 h-40 bg-brand-500/10 rounded-full blur-3xl group-hover:bg-brand-500/20 transition duration-1000"></div>

    <div class="flex items-start justify-between relative z-10">
        <div>
            <h3 class="label-text flex items-center gap-2">
                <span class="text-brand-500">⚡</span> ESI Token Health
            </h3>
            <p class="text-slate-400 text-xs max-w-md mt-1">Health of authentication tokens for linked characters.</p>
        </div>
        <div class="text-right">
            <div class="text-3xl font-bold font-mono {% if esi_health_percent > 80 %}text-green-400{% else %}text-brand-400{% endif %}">
                {{ esi_health_percent }}%
            </div>
            <div class="text-[10px] text-slate-500 uppercase tracking-wider font-bold">Global Score</div>
        </div>
    </div>

    <div class="space-y-2 mt-6 relative z-10">
        <!-- Visual Bar -->
        <div class="w-full bg-dark-900/50 rounded-full h-3 overflow-hidden border border-white/5">
            <div class="bg-gradient-to-r from-green-500 to-emerald-400 h-full rounded-full shadow-[0_0_15px_rgba(34,197,94,0.4)] transition-all duration-1000 relative" style="width: {{ esi_health_percent }}%">
                <div class="absolute inset-0 bg-white/20 animate-pulse"></div>
            </div>
        </div>

        <!-- STATS GRID -->
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mt-6">
            <!-- 1. Stale -->
            <div class="bg-white/5 p-3 rounded-lg border border-white/5 flex flex-col justify-center items-center text-center hover:bg-white/10 transition">
                <span class="label-text mb-1">Stale (>60m)</span>
                <span class="{% if stale_count > 0 %}text-brand-500{% else %}text-slate-500{% endif %} font-bold text-xl leading-none font-mono">{{ stale_count }}</span>
            </div>

            <!-- 2. Invalid -->
            <div class="bg-white/5 p-3 rounded-lg border border-white/5 flex flex-col justify-center items-center text-center hover:bg-white/10 transition">
                <span class="label-text mb-1">Invalid Token</span>
                <span class="{% if invalid_token_count > 0 %}text-red-500{% else %}text-slate-500{% endif %} font-bold text-xl leading-none font-mono">{{ invalid_token_count }}</span>
            </div>

            <!-- 3. Online -->
            <div class="bg-white/5 p-3 rounded-lg border border-white/5 flex flex-col justify-center items-center text-center">
                <span class="label-text mb-1 text-green-400">Online Now</span>
                <span class="text-white font-bold text-xl leading-none font-mono">{{ users_online_count }}</span>
            </div>

            <!-- 4. Active -->
            <div class="bg-white/5 p-3 rounded-lg border border-white/5 flex flex-col justify-center items-center text-center">
                <span class="label-text mb-1 text-blue-400">Active (30d)</span>
                <span class="text-white font-bold text-xl leading-none font-mono">{{ active_30d_count }}</span>
            </div>

            <!-- 5. Total -->
            <div class="bg-white/5 p-3 rounded-lg border border-white/5 flex flex-col justify-center items-center text-center">
                <span class="label-text mb-1 text-purple-400">Total Pilots</span>
                <span class="text-white font-bold text-xl leading-none font-mono">{{ total_characters }}</span>
            </div>

            <!-- 6. ESI Status -->
            <div class="bg-white/5 p-3 rounded-lg border border-white/5 flex flex-col justify-center items-center text-center">
                <span class="label-text mb-1">ESI Status</span>
                {% if esi_server_status %}
                <span class="text-green-400 font-bold text-xl leading-none font-mono flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> ONLINE
                </span>
                {% else %}
                <span class="text-red-500 font-bold text-xl leading-none font-mono flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span> DOWN
                </span>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- INFRASTRUCTURE METRICS -->
<div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-6">
    <!-- Redis -->
    <div class="glass-panel p-6">
        <h2 class="label-text mb-2">Redis Broker</h2>
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                {% if redis_status == "ONLINE" %}
                <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse shadow-lg shadow-green-500/50"></span>
                <span class="text-lg font-bold text-green-400">ONLINE</span>
                {% else %}
                <span class="w-2 h-2 bg-red-600 rounded-full animate-pulse"></span>
                <span class="text-lg font-bold text-red-400">OFFLINE</span>
                {% endif %}
            </div>
            <div class="text-[10px] text-slate-500 font-mono bg-white/5 px-2 py-1 rounded">
                {{ redis_latency|default:"<1" }}ms
            </div>
        </div>
    </div>

    <!-- Workers -->
    <div class="glass-panel p-6">
        <h2 class="label-text mb-2">Worker Nodes</h2>
        <div class="flex items-baseline gap-2">
            <span class="text-3xl font-bold text-white font-mono">{{ worker_count }}</span>
            <span class="text-xs text-slate-500 uppercase tracking-wide">Active</span>
        </div>
    </div>

    <!-- Throughput -->
    <div class="glass-panel p-6">
        <h2 class="label-text mb-2">Total Processed</h2>
        <div class="flex items-baseline gap-2">
            <span class="text-3xl font-bold text-white font-mono">{{ total_processed|intword }}</span>
            <span class="text-xs text-slate-500 uppercase tracking-wide">Tasks</span>
        </div>
    </div>

    <!-- Load (Derived from Queue) - NOW DYNAMIC -->
    <div class="glass-panel p-6">
        <h2 class="label-text mb-2">System Load</h2>
        <div class="flex items-baseline gap-2">
            <!-- Inline style uses HSL for smooth Green -> Red gradient -->
            <span class="text-3xl font-bold font-mono transition-colors duration-500"
                  style="color: hsl({{ load_hue }}, 80%, 50%)">
                {{ system_load_percent }}%
            </span>
            <span class="text-xs text-slate-500 uppercase tracking-wide">Load</span>
        </div>
        <!-- Progress Bar -->
        <div class="w-full bg-dark-900/50 h-1.5 mt-4 rounded-full overflow-hidden border border-white/5">
            <div class="h-full rounded-full transition-all duration-500 shadow-[0_0_10px_currentColor]"
                 style="width: {{ system_load_percent }}%; background-color: hsl({{ load_hue }}, 80%, 50%)"></div>
        </div>
    </div>
</div>

<!-- QUEUE & WORKER DASHBOARD (SPLIT LAYOUT) -->
<div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-6">

    <!-- 1. ACTIVE QUEUE -->
    <div class="glass-panel p-0 overflow-hidden flex flex-col h-fit">
        <div class="p-4 bg-white/5 border-b border-white/5 flex justify-between items-center">
            <h3 class="font-bold text-white flex items-center gap-2 text-sm">
                <span class="text-lg text-blue-400">⚡</span> Active Queue
            </h3>
            <span class="badge badge-slate border-blue-500/30 text-blue-300">{{ queue_length }}</span>
        </div>

        <div class="overflow-y-auto custom-scrollbar max-h-96">
            {% if queued_breakdown %}
            <table class="w-full text-left text-xs">
                <thead class="text-[9px] text-slate-500 font-bold uppercase bg-black/20">
                    <tr>
                        <th class="px-4 py-2">Task Type</th>
                        <th class="px-4 py-2 text-right">Count</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/5">
                    {% for stat in queued_breakdown %}
                    <tr class="hover:bg-white/5 transition group">
                        <td class="px-4 py-2.5 font-medium text-blue-200 group-hover:text-white transition">{{ stat.endpoint_name|title }}</td>
                        <td class="px-4 py-2.5 text-right font-mono text-white">{{ stat.pending_count }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="p-8 text-center text-slate-500 text-xs italic">
                Active queue is empty.
            </div>
            {% endif %}
        </div>
    </div>

    <!-- 2. DELAYED / THROTTLED -->
    <div class="glass-panel p-0 overflow-hidden flex flex-col h-fit border-slate-700/50">
        <div class="p-4 bg-slate-900/50 border-b border-white/5 flex justify-between items-center">
            <h3 class="font-bold text-slate-300 flex items-center gap-2 text-sm">
                <span class="text-lg text-amber-500">⏳</span> Throttled
            </h3>
        </div>

        <div class="overflow-y-auto custom-scrollbar max-h-96">
            {% if delayed_breakdown %}
            <table class="w-full text-left text-xs">
                <thead class="text-[9px] text-slate-500 font-bold uppercase bg-black/20">
                    <tr>
                        <th class="px-4 py-2">Task Type</th>
                        <th class="px-4 py-2 text-right">Count</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/5">
                    {% for stat in delayed_breakdown %}
                    <tr class="hover:bg-white/5 transition group">
                        <td class="px-4 py-2.5 font-medium text-slate-400 group-hover:text-slate-200 transition">{{ stat.endpoint_name|title }}</td>
                        <td class="px-4 py-2.5 text-right font-mono text-slate-300">{{ stat.pending_count }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="p-8 text-center text-slate-600 text-xs italic">
                No delayed tasks.
            </div>
            {% endif %}
        </div>
    </div>

    <!-- 3. WORKER NODES (Spanning 2 columns) -->
    <div class="lg:col-span-2 space-y-4">
        {% if workers %}
        {% for worker in workers %}
        <div class="glass-panel overflow-hidden border border-white/5">
            <!-- Worker Header -->
            <div class="bg-slate-800/50 px-4 py-3 border-b border-white/5 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.8)]"></div>
                    <span class="font-bold text-slate-200 text-sm font-mono">{{ worker.name }}</span>
                    <span class="text-xs text-slate-500 font-mono ml-2 opacity-50">PID: {{ worker.pid }}</span>
                </div>
                <div class="flex gap-4 text-xs font-mono text-slate-400">
                    <span>Concurrency: <span class="text-white">{{ worker.concurrency }}</span></span>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-white/5">

                <!-- ACTIVE TASKS COLUMN -->
                <div class="p-4 bg-dark-900/30 min-h-[120px]">
                    <h4 class="text-[10px] uppercase font-bold text-slate-500 mb-3 flex items-center justify-between">
                        <span>Active Processing</span>
                        <span class="bg-brand-500/10 text-brand-400 px-1.5 py-0.5 rounded border border-brand-500/20 font-mono">{{ worker.active_count }}</span>
                    </h4>

                    {% if worker.active_tasks %}
                    <div class="space-y-2">
                        {% for task in worker.active_tasks %}
                        <div class="bg-slate-800/80 p-2.5 rounded border border-white/5 text-xs shadow-sm hover:border-brand-500/30 transition">

                            {% if task.enriched_name %}
                            <!-- CHAR REFRESH TASK LAYOUT (Rich Display) -->
                            <div class="flex flex-col gap-1">
                                <div class="flex justify-between items-start">
                                    <span class="font-bold text-white truncate text-sm">
                                        {{ task.enriched_name }}
                                    </span>
                                    <span class="font-mono text-brand-400 text-[10px] bg-brand-900/10 px-1 rounded border border-brand-500/10 whitespace-nowrap">
                                        {{ task.time_start|date:"H:i:s" }}
                                    </span>
                                </div>
                                <div class="flex justify-between items-center text-[10px]">
                                    <span class="text-slate-400 font-mono">ID: {{ task.enriched_char_id }}</span>
                                </div>
                                <div class="text-[10px] text-blue-300 font-mono truncate border-t border-white/5 pt-1 mt-0.5">
                                    <span class="text-slate-500">▶</span> {{ task.enriched_info }}
                                </div>
                            </div>

                            {% else %}
                            <!-- GENERIC TASK LAYOUT (Fallback) -->
                            <div class="flex justify-between items-start mb-1">
                                <span class="font-bold text-white truncate max-w-[140px]" title="{{ task.name }}">
                                    {{ task.name|cut:"scheduler.tasks."|cut:"waitlist_project." }}
                                </span>
                                <span class="font-mono text-brand-400 text-[10px] bg-brand-900/10 px-1 rounded border border-brand-500/10">{{ task.time_start|date:"H:i:s" }}</span>
                            </div>
                            <div class="font-mono text-[10px] text-slate-500 truncate mt-1 bg-black/20 p-1 rounded border border-white/5" title="Args: {{ task.args }}">
                                Args: {{ task.args|default:"[]" }}
                            </div>
                            {% endif %}

                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4 text-slate-600 text-xs italic flex flex-col items-center gap-2 mt-4">
                        <span class="text-xl opacity-20">💤</span>
                        Worker is idle
                    </div>
                    {% endif %}
                </div>

                <!-- RESERVED TASKS COLUMN -->
                <div class="p-4 bg-dark-900/30 min-h-[120px]">
                    <h4 class="text-[10px] uppercase font-bold text-slate-500 mb-3 flex items-center justify-between">
                        <span>Prefetched / Reserved</span>
                        <span class="bg-blue-500/10 text-blue-400 px-1.5 py-0.5 rounded border border-blue-500/20 font-mono">{{ worker.reserved_count }}</span>
                    </h4>

                    {% if worker.reserved_count > 0 %}
                    <div class="p-4 bg-blue-900/5 rounded border border-blue-500/10 text-center mt-2">
                        <span class="text-3xl font-bold text-blue-400 font-mono block">{{ worker.reserved_count }}</span>
                        <span class="text-[9px] text-blue-300/60 uppercase font-bold tracking-wide">Tasks Buffered</span>
                    </div>
                    {% else %}
                    <div class="text-center py-4 text-slate-600 text-xs italic flex flex-col items-center gap-2 mt-4">
                        <span class="text-xl opacity-20">📥</span>
                        Buffer empty
                    </div>
                    {% endif %}
                </div>

            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="p-8 text-center border-2 border-dashed border-slate-800 rounded-xl">
            <span class="text-slate-600 font-bold">No Workers Detected</span>
        </div>
        {% endif %}
    </div>
</div>