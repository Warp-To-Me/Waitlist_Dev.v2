{% extends base_template|default:'base.html' %}

{% block title %}Fleet Doctrines{% endblock %}

{% block content %}
<div class="container mx-auto p-4 md:p-8">

    <!-- HEADER -->
    <div class="flex flex-col md:flex-row justify-between items-end gap-4 mb-8">
        <div>
            <h1 class="text-3xl font-bold text-white">
                <span class="text-amber-500">Doctrine</span> Fittings
            </h1>
            <p class="text-slate-400 text-sm mt-1">
                Approved fleet compositions. Click on a category to expand it.
            </p>
        </div>

        <!-- Search Bar -->
        <div class="relative w-full md:w-96">
            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
            <input type="text"
                   id="fit-search"
                   onkeyup="filterFits()"
                   class="block w-full p-3 pl-10 text-sm text-white border border-slate-600 rounded-lg bg-slate-800 focus:ring-amber-500 focus:border-amber-500 placeholder-slate-500 shadow-xl transition focus:bg-slate-700"
                   placeholder="Search ship, fit name, or role...">
        </div>
    </div>

    <!-- CONTENT AREA -->
    <div id="doctrine-container" class="animate-fade-in">
        {% include 'doctrines/public_content.html' %}
    </div>

</div>

<!-- FIT DETAIL MODAL -->
<div id="fit-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <!-- Backdrop -->
    <div class="fixed inset-0 bg-slate-900/90 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>

    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">

            <!-- Modal Panel -->
            <div class="relative transform overflow-hidden rounded-lg bg-slate-800 text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-2xl border border-slate-700">

                <!-- Header -->
                <div class="bg-slate-900 px-4 py-3 sm:px-6 flex justify-between items-center border-b border-slate-700">
                    <h3 class="text-lg font-semibold leading-6 text-white" id="modal-title">Fit Details</h3>
                    <button type="button" onclick="closeModal()" class="text-slate-400 hover:text-white transition">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <!-- Content -->
                <div class="px-4 py-4 sm:p-6 grid grid-cols-1 md:grid-cols-3 gap-6">

                    <!-- Left: Info & Stats -->
                    <div class="md:col-span-1 text-center md:text-left flex flex-col items-center md:items-start">
                        <div class="relative w-32 h-32 mb-4 group">
                            <div class="absolute inset-0 bg-gradient-to-t from-slate-900 to-transparent rounded-lg"></div>
                            <img id="modal-img" src="" class="w-full h-full object-contain rounded-lg border border-slate-700 bg-slate-900/50 shadow-lg" alt="Ship">
                        </div>

                        <h2 id="modal-hull" class="text-xl font-bold text-white leading-none"></h2>
                        <h4 id="modal-fitname" class="text-sm text-amber-500 font-mono mb-2 mt-1"></h4>
                        <div class="w-full h-px bg-slate-700 my-3"></div>
                        <p id="modal-desc" class="text-xs text-slate-400 italic mb-4 leading-relaxed"></p>
                    </div>

                    <!-- Right: EFT Block -->
                    <div class="md:col-span-2">
                        <div class="flex justify-between items-end mb-2">
                            <label class="text-[10px] font-bold uppercase text-slate-500 tracking-wider">EFT Format</label>
                            <button onclick="copyToClipboard()" class="text-xs bg-amber-600 hover:bg-amber-500 text-white px-3 py-1.5 rounded font-bold transition shadow-lg shadow-amber-900/20 flex items-center gap-1 active:scale-95">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" /><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" /></svg>
                                Copy to Clipboard
                            </button>
                        </div>
                        <textarea id="modal-eft" class="w-full h-72 bg-slate-950 text-green-400 font-mono text-xs p-3 rounded border border-slate-700 focus:outline-none resize-none shadow-inner" readonly></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- ACCORDION LOGIC ---
    function toggleAccordion(id) {
        const content = document.getElementById(id);
        const icon = document.getElementById(`icon-${id}`);
        const header = document.getElementById(`header-${id}`);

        if (!content) return;

        if (content.classList.contains('hidden')) {
            // Expand
            content.classList.remove('hidden');
            if (icon) icon.style.transform = 'rotate(180deg)';
            if (header) header.setAttribute('data-expanded', 'true');
        } else {
            // Collapse
            content.classList.add('hidden');
            if (icon) icon.style.transform = 'rotate(0deg)';
            if (header) header.setAttribute('data-expanded', 'false');
        }
    }

    // Explicit Helper to Force Expand (Recursively expands up the tree)
    function expandToRoot(element) {
        // Find the nearest parent content container (accordion-content)
        const parentContent = element.closest('.accordion-content');

        if (parentContent) {
            // Unhide it
            parentContent.classList.remove('hidden');

            // Rotate its specific icon using the ID convention
            // ID format is usually "root-X", "l1-X", etc.
            const contentId = parentContent.id;
            const icon = document.getElementById(`icon-${contentId}`);
            if (icon) icon.style.transform = 'rotate(180deg)';

            // Recursively go up
            expandToRoot(parentContent.parentElement);
        }
    }

    // --- SEARCH LOGIC ---
    function filterFits() {
        const input = document.getElementById('fit-search');
        const filter = input.value.toUpperCase();
        const rows = document.querySelectorAll('.fit-row');

        // 1. Hide/Show Individual Rows
        rows.forEach(row => {
            const text = row.getAttribute('data-search').toUpperCase();

            if (text.indexOf(filter) > -1) {
                row.style.display = ""; // Show
                if (filter.length > 0) {
                    expandToRoot(row);
                }
            } else {
                row.style.display = "none"; // Hide
            }
        });

        // 2. Hide Empty Containers (Optional visual polish)
        // This is complex to do efficiently in vanilla JS on every keypress without lag
        // So we just rely on expanding parents of matching items.
    }

    // --- MODAL LOGIC ---
    function openFit(fitId) {
        const modal = document.getElementById('fit-modal');

        // Fetch Data
        fetch(`/doctrines/api/${fitId}/`)
            .then(res => res.json())
            .then(data => {
                document.getElementById('modal-hull').textContent = data.hull;
                document.getElementById('modal-fitname').textContent = data.name;
                document.getElementById('modal-desc').textContent = data.description || "No description available.";
                document.getElementById('modal-eft').value = data.eft_block;
                document.getElementById('modal-img').src = `https://images.evetech.net/types/${data.hull_id}/render?size=512`;

                modal.classList.remove('hidden');
            });
    }

    function closeModal() {
        document.getElementById('fit-modal').classList.add('hidden');
    }

    function copyToClipboard() {
        const copyText = document.getElementById("modal-eft");
        copyText.select();
        copyText.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(copyText.value);
    }
</script>
{% endblock %}