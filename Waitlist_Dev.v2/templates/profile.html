{% extends base_template|default:"base.html" %}
{% load humanize %}

{% block title %}Pilot Profile - {{ active_char.character_name }}{% endblock %}

{% block content %}
<!--
    PROFILE PAGE SCROLL WRAPPER
    Required because body is now overflow:hidden.
-->
<div class="absolute inset-0 overflow-y-auto custom-scrollbar">
    <!-- Changed from max-w-[1080px] to container to match navbar width -->
    <div class="container mx-auto p-4 md:p-8 relative" id="profile-content-area">
        {% include 'partials/profile_content.html' %}
    </div>
</div>

<!-- Scripts -->
<script>
    // Define variable on window to ensure it persists correctly across re-renders
    if (typeof window.profilePollingInterval !== 'undefined') {
        clearInterval(window.profilePollingInterval);
    }
    window.profilePollingInterval = null;

    var initialTimestamp = "{{ active_char.last_updated.isoformat }}";

    function scrollToActiveChar() {
        setTimeout(() => {
            const activeId = "{{ active_char.character_id }}";
            const activeCard = document.getElementById("char-card-" + activeId);
            if (activeCard) {
                activeCard.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
        }, 50);
    }

    function initProfilePage() {
        console.log("Initializing Profile Page...");
        scrollToActiveChar();

        const lastUpdatedStr = "{{ active_char.last_updated|date:'c' }}";
        if (!lastUpdatedStr) return;

        const lastUpdated = new Date(lastUpdatedStr);
        const now = new Date();
        const diffMinutes = (now - lastUpdated) / 1000 / 60;

        const isStale = diffMinutes > 5;
        const isEmpty = {{ active_char.total_sp|default:0 }} === 0;

        // Check if we just completed a refresh to avoid loops
        const justRefreshed = sessionStorage.getItem("just_refreshed");
        if (justRefreshed) {
            sessionStorage.removeItem("just_refreshed");
            return;
        }

        if (isStale || isEmpty) {
            triggerRefresh();
        }
    }

    // NON-BLOCKING REFRESH LOGIC
    window.triggerRefresh = function() {
        const timeDisplay = document.getElementById('last-updated-time');
        if (timeDisplay) {
            // Show inline spinner/indicator
            timeDisplay.innerHTML = `
                <span class="text-brand-400 animate-pulse flex items-center gap-1">
                    <svg class="animate-spin h-3 w-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Syncing...
                </span>`;
        }

        // Fire and Forget (Queue Task)
        fetch("{% url 'api_refresh_profile' active_char.character_id %}")
            .then(response => response.json())
            .then(data => {
                if (data.success && data.status === 'queued') {
                    console.log("Update queued. Starting poll...");
                    startPolling();
                } else {
                    console.error("Failed to queue update");
                }
            })
            .catch(err => console.error("API Error", err));
    }

    function startPolling() {
        if (window.profilePollingInterval) clearInterval(window.profilePollingInterval);

        let attempts = 0;
        const maxAttempts = 60; // Stop after ~2 minutes

        window.profilePollingInterval = setInterval(() => {
            // --- CRITICAL SAFETY CHECK ---
            // If the user has navigated away (element is gone), STOP POLLING immediately.
            const indicator = document.getElementById('last-updated-time');
            if (!indicator) {
                console.log("User navigated away. Stopping background poll.");
                clearInterval(window.profilePollingInterval);
                return;
            }
            // -----------------------------

            attempts++;
            if(attempts > maxAttempts) {
                clearInterval(window.profilePollingInterval);
                return;
            }

            fetch("{% url 'api_pilot_status' active_char.character_id %}")
                .then(r => r.json())
                .then(status => {
                    // Compare timestamps
                    if (status.last_updated && status.last_updated !== initialTimestamp) {
                        console.log("Data updated detected!");
                        clearInterval(window.profilePollingInterval);
                        reloadPartial();
                    }
                })
                .catch(e => console.warn("Poll failed", e));

        }, 2000); // Check every 2s
    }

    function reloadPartial() {
        // Safety check before reloading
        if (!document.getElementById('profile-content-area')) return;

        fetch("{% url 'profile' %}?partial=true", {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(htmlResp => htmlResp.text())
        .then(html => {
            const contentArea = document.getElementById('profile-content-area');
            if (contentArea) {
                contentArea.innerHTML = html;
                sessionStorage.setItem("just_refreshed", "true");
                scrollToActiveChar();
            }
        });
    }

    // UI Helpers
    window.scrollContainer = function(direction) {
        const container = document.getElementById('char-scroll-container');
        if (container) {
            const scrollAmount = 300;
            if (direction === 'left') { container.scrollLeft -= scrollAmount; }
            else { container.scrollLeft += scrollAmount; }
        }
    };

    window.openTab = function(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(el => {
            el.classList.remove('border-brand-500', 'text-brand-500');
            el.classList.add('border-transparent', 'text-slate-400');
        });
        const content = document.getElementById(tabId);
        if(content) content.classList.remove('hidden');
        const btn = document.getElementById('btn-' + tabId);
        if(btn) {
            btn.classList.remove('border-transparent', 'text-slate-400');
            btn.classList.add('border-brand-500', 'text-brand-500');
        }
    };

    initProfilePage();
</script>
{% endblock %}