{% extends 'management/base_management.html' %}

{% block title %}Manage Fleet{% endblock %}

{% block management_content %}
<div class="flex flex-col h-[calc(100vh-8rem)] bg-dark-950 overflow-hidden relative rounded-xl border border-white/5 shadow-2xl">

    <!-- HEADER -->
    <div class="glass-header px-6 py-4 flex justify-between items-center shrink-0 bg-slate-900/90 z-20 border-b border-white/10">
        <div>
            <h1 class="heading-1 flex items-center gap-3">
                <span class="text-3xl">📡</span> Manage Fleet: {{ fleet.name }}
            </h1>
            <p class="text-slate-400 text-sm mt-1 font-mono">ID: {{ fleet.esi_fleet_id|default:"Offline Mode" }}</p>
        </div>
        <div class="flex gap-2 items-center">

            {% if not fleet.esi_fleet_id %}
            <button onclick="linkEsiFleet()" id="btn-link-esi" class="btn-secondary text-xs py-1.5 px-3 border-blue-500/30 text-blue-400 hover:bg-blue-500/10 shadow-lg shadow-blue-500/10">
                <span>🔗</span> Link ESI
            </button>
            <div class="w-px h-6 bg-white/10 mx-1"></div>
            {% endif %}

            <button onclick="closeFleet()" class="btn-danger text-xs py-1.5 px-3 shadow-lg shadow-red-500/20 mr-1 border-red-500/50 hover:bg-red-900/80">
                <span>☠️</span> Close Fleet
            </button>
            <a href="{% url 'fleet_dashboard' fleet.join_token %}" class="btn-secondary text-xs py-1.5 px-3">
                Back to Dashboard
            </a>
            <button onclick="saveSettings()" id="save-btn" class="btn-primary text-xs py-1.5 px-4 shadow-lg shadow-brand-500/20">
                <span>💾</span> Update Fleet
            </button>
        </div>
    </div>

    <!-- MAIN GRID -->
    <div class="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6 p-6 overflow-hidden">

        <!-- LEFT: MOTD EDITOR -->
        <div class="glass-panel p-6 flex flex-col gap-4 overflow-y-auto custom-scrollbar">
            <h3 class="label-text">Message of the Day (MOTD)</h3>

            <!-- Toolbar -->
            <div class="flex gap-1 bg-black/20 p-2 rounded border border-white/5 items-center flex-wrap">
                <button onclick="insertTag('b')" class="p-1 px-2 bg-slate-800 rounded border border-white/10 text-xs font-bold text-slate-300 hover:text-white" title="Bold">B</button>
                <button onclick="insertTag('i')" class="p-1 px-2 bg-slate-800 rounded border border-white/10 text-xs italic text-slate-300 hover:text-white" title="Italic">I</button>
                <button onclick="insertTag('u')" class="p-1 px-2 bg-slate-800 rounded border border-white/10 text-xs underline text-slate-300 hover:text-white" title="Underline">U</button>
                <button onclick="insertTag('br')" class="p-1 px-2 bg-slate-800 rounded border border-white/10 text-xs text-slate-300 hover:text-white" title="Line Break">&crarr;</button>

                <div class="w-px h-6 bg-white/10 mx-1"></div>

                <!-- Fixed Colors -->
                <button onclick="insertColor('green')" class="p-1 px-2 bg-slate-800 rounded border border-white/10 text-xs text-green-400 hover:text-green-300" title="Green">A</button>
                <button onclick="insertColor('red')" class="p-1 px-2 bg-slate-800 rounded border border-white/10 text-xs text-red-400 hover:text-red-300" title="Red">A</button>
                <button onclick="insertColor('yellow')" class="p-1 px-2 bg-slate-800 rounded border border-white/10 text-xs text-yellow-400 hover:text-yellow-300" title="Yellow">A</button>
                <button onclick="insertColor('blue')" class="p-1 px-2 bg-slate-800 rounded border border-white/10 text-xs text-blue-400 hover:text-blue-300" title="Blue">A</button>
                <button onclick="insertColor('#b2b2b2')" class="p-1 px-2 bg-slate-800 rounded border border-white/10 text-xs text-slate-400 hover:text-white" title="Grey">A</button>

                <div class="w-px h-6 bg-white/10 mx-1"></div>

                <!-- Full Color Picker -->
                <div class="relative group cursor-pointer" title="Custom Color">
                    <button onclick="triggerColorPicker()" class="p-1 px-2 bg-slate-800 rounded border border-white/10 text-xs hover:bg-slate-700 flex items-center justify-center">
                        <span class="text-lg leading-none">🎨</span>
                    </button>
                    <input type="color" id="color-picker" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full" onchange="insertColor(this.value)">
                </div>
            </div>

            <!-- Editor -->
            <textarea id="motd-input" maxlength="4000" class="input-field flex-grow font-mono text-xs leading-relaxed resize-none p-4" placeholder="Enter fleet MOTD...">{{ fleet.motd }}</textarea>

            <div class="flex justify-between items-center text-[10px] text-slate-500">
                <span class="italic">Changes are pushed to EVE immediately.</span>
                <span><span id="char-count">{{ fleet.motd|length }}</span>/4000</span>
            </div>

            <!-- NEW: Preview Box (Scaled Down) -->
            <div class="mt-2 pt-2 border-t border-white/5">
                <h4 class="label-text mb-1 flex items-center gap-2 text-[10px]">
                    <span class="text-sm">👁️</span> Live Preview
                </h4>
                <!-- FIXED: Used inline style to guarantee font sizing -->
                <div id="motd-preview" style="font-size: 10px; line-height: 1.2;" class="bg-black/40 border border-white/10 rounded p-2 text-slate-300 font-sans whitespace-pre-wrap min-h-[60px] overflow-y-auto max-h-40 shadow-inner"></div>
            </div>
        </div>

        <!-- RIGHT: STRUCTURE BUILDER -->
        <div class="glass-panel p-6 flex flex-col bg-slate-900/50 border border-white/10">
            <div class="flex justify-between items-center mb-4 pb-2 border-b border-white/5">
                <h3 class="label-text mb-0">Active Fleet Structure</h3>
                <button onclick="addWing()" class="btn-secondary py-1 px-3 text-xs bg-slate-800 border-slate-700 hover:border-white/30">
                    + Add Wing
                </button>
            </div>

            <div id="structure-container" class="flex-grow overflow-y-auto custom-scrollbar space-y-4 pr-2">
                <div class="text-center text-slate-500 py-12 italic">Fetching active structure...</div>
            </div>

            <div class="text-[10px] text-slate-500 italic mt-4 border-t border-white/5 pt-2">
                Removing wings or squads from this list will DELETE them in-game. Be careful.
            </div>
        </div>

    </div>
</div>

<script>
    var CSRF_TOKEN = '{{ csrf_token }}';

    document.addEventListener('DOMContentLoaded', () => {
        // Parse initial structure
        try {
            const raw = `{{ initial_structure|escapejs }}`;
            structure = JSON.parse(raw);
            renderStructure();
        } catch(e) {
            console.error("Structure Parse Error", e);
            document.getElementById('structure-container').innerHTML = '<div class="text-red-400 text-center text-xs">Error loading structure.</div>';
        }

        // Char Counter & Preview Init
        const motdInput = document.getElementById('motd-input');
        const preview = document.getElementById('motd-preview');
        const count = document.getElementById('char-count');

        function updatePreview() {
            const val = motdInput.value;
            count.innerText = val.length;
            preview.innerHTML = val;
        }

        motdInput.addEventListener('input', updatePreview);

        // Initial run
        updatePreview();
    });

    // --- COLOR PICKER HELPER ---
    function triggerColorPicker() {
        document.getElementById('color-picker').click();
    }

    // --- MOTD LOGIC ---
    function insertTag(tag) {
        const input = document.getElementById('motd-input');
        const start = input.selectionStart;
        const end = input.selectionEnd;
        const text = input.value;
        const selected = text.substring(start, end);

        let replace = "";
        if (tag === 'br') replace = "<br>";
        else replace = `<${tag}>${selected}</${tag}>`;

        input.value = text.substring(0, start) + replace + text.substring(end);
        input.focus();
        input.selectionStart = start + replace.length;
        input.selectionEnd = start + replace.length;
        input.dispatchEvent(new Event('input')); // Triggers preview update
    }

    function insertColor(color) {
        const input = document.getElementById('motd-input');
        const start = input.selectionStart;
        const end = input.selectionEnd;
        const text = input.value;
        const selected = text.substring(start, end);

        // Handle hex vs names (though we pass hex from picker)
        let hex = color;
        if(color === 'green') hex = "#00ff00";
        if(color === 'red') hex = "#ff0000";
        if(color === 'yellow') hex = "#ffff00";
        if(color === 'blue') hex = "#00ffff";

        const replace = `<font color="${hex}">${selected}</font>`;
        input.value = text.substring(0, start) + replace + text.substring(end);
        input.focus();
        input.selectionStart = start + replace.length;
        input.selectionEnd = start + replace.length;
        input.dispatchEvent(new Event('input')); // Triggers preview update
    }

    // --- STRUCTURE LOGIC ---
    let structure = [];

    function renderStructure() {
        const container = document.getElementById('structure-container');
        container.innerHTML = '';

        if (structure.length === 0) {
            container.innerHTML = '<div class="text-center text-slate-500 py-12 italic">No wings defined.</div>';
            return;
        }

        structure.forEach((wing, wIndex) => {
            const wingEl = document.createElement('div');
            wingEl.className = "bg-slate-800 rounded-lg border border-slate-700 overflow-hidden group/wing";

            // Render Squads
            let squadsHtml = '';
            wing.squads.forEach((squad, sIndex) => {
                squadsHtml += `
                <div class="flex items-center gap-2 mb-2 pl-4 relative">
                    <div class="absolute left-2 top-0 bottom-1/2 border-l-2 border-slate-600 w-2 h-full rounded-bl"></div>
                    <div class="w-2 border-b-2 border-slate-600 h-0 mr-1"></div>
                    <input type="text" value="${squad}"
                           class="bg-dark-900 border border-slate-700 rounded px-2 py-1 text-xs text-white w-full focus:border-brand-500 outline-none"
                           onchange="updateSquad(${wIndex}, ${sIndex}, this.value)">
                    <button onclick="removeSquad(${wIndex}, ${sIndex})" class="text-slate-600 hover:text-red-400 px-1">×</button>
                </div>`;
            });

            wingEl.innerHTML = `
                <div class="p-2 bg-slate-700/50 flex justify-between items-center border-b border-slate-700">
                    <div class="flex items-center gap-2 w-full">
                        <span class="text-slate-400 text-[10px] font-bold uppercase w-8">Wing</span>
                        <input type="text" value="${wing.name}"
                               class="bg-transparent border-b border-transparent hover:border-slate-500 focus:border-brand-500 text-white font-bold text-sm outline-none w-full transition px-1"
                               onchange="updateWing(${wIndex}, this.value)">
                    </div>
                    <div class="flex gap-1 opacity-0 group-hover/wing:opacity-100 transition shrink-0 ml-2">
                        <button onclick="addSquad(${wIndex})" class="text-[10px] bg-slate-600 hover:bg-slate-500 px-1.5 py-0.5 rounded text-white border border-slate-500/50">+Sq</button>
                        <button onclick="removeWing(${wIndex})" class="text-[10px] bg-red-900/30 text-red-400 hover:bg-red-900/50 px-1.5 py-0.5 rounded border border-red-900/50">Del</button>
                    </div>
                </div>
                <div class="p-2 bg-dark-900/30">
                    ${squadsHtml}
                    ${wing.squads.length === 0 ? '<div class="text-[10px] text-slate-600 italic pl-8">No squads</div>' : ''}
                </div>
            `;
            container.appendChild(wingEl);
        });
    }

    // --- MUTATORS ---
    function addWing() {
        structure.push({ name: `Wing ${structure.length + 1}`, squads: [] });
        renderStructure();
    }

    function removeWing(index) {
        if(!confirm("Deleting a Wing deletes all its Squads. Pilots may be kicked. Continue?")) return;
        structure.splice(index, 1);
        renderStructure();
    }

    function updateWing(index, val) {
        structure[index].name = val;
    }

    function addSquad(wIndex) {
        const count = structure[wIndex].squads.length + 1;
        structure[wIndex].squads.push(`Squad ${count}`);
        renderStructure();
    }

    function removeSquad(wIndex, sIndex) {
        structure[wIndex].squads.splice(sIndex, 1);
        renderStructure();
    }

    function updateSquad(wIndex, sIndex, val) {
        structure[wIndex].squads[sIndex] = val;
    }

    // --- SAVE ---
    function saveSettings() {
        const btn = document.getElementById('save-btn');
        const orig = btn.innerHTML;
        btn.textContent = "Updating...";
        btn.disabled = true;

        const motd = document.getElementById('motd-input').value;

        fetch("{% url 'api_update_fleet_settings' fleet.join_token %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': CSRF_TOKEN,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                motd: motd,
                structure: structure
            })
        })
        .then(r => r.json())
        .then(d => {
            if(d.success) {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-success');
                btn.textContent = "Synced!";
                setTimeout(() => {
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-primary');
                    btn.innerHTML = orig;
                    btn.disabled = false;
                }, 2000);
            } else {
                alert("Update Failed: " + d.error);
                btn.innerHTML = orig;
                btn.disabled = false;
            }
        })
        .catch(e => {
            alert("Network Error");
            btn.innerHTML = orig;
            btn.disabled = false;
        });
    }

    // --- CLOSE FLEET ---
    function closeFleet() {
        if (!confirm("Are you sure you want to CLOSE this fleet? This stops the waitlist.")) return;

        fetch("{% url 'api_close_fleet' fleet.join_token %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': CSRF_TOKEN }
        })
        .then(r => r.json())
        .then(d => {
            if (d.success) {
                window.location.href = "{% url 'management_fleets' %}";
            } else {
                alert("Error closing fleet: " + d.error);
            }
        })
        .catch(e => alert("Network error"));
    }

    // --- LINK ESI FLEET ---
    function linkEsiFleet() {
        const btn = document.getElementById('btn-link-esi');
        const originalText = btn.innerHTML;
        btn.innerHTML = 'Linking...';
        btn.disabled = true;

        fetch("{% url 'api_link_esi_fleet' fleet.join_token %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': CSRF_TOKEN }
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert("Fleet successfully linked! ID: " + data.fleet_id);
                // Reload to show online status and update UI
                location.reload();
            } else {
                alert("Link Failed: " + data.error);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        })
        .catch(e => {
            alert("Network Error");
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
    }
</script>
{% endblock %}